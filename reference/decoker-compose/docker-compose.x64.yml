version: '3.8'

services:
  ibkr-n8n-combined:
    container_name: ibkr-n8n-combined
    build:
      context: .
      dockerfile: Dockerfile.combined.x64
    platform: linux/amd64
    ports:
      - 5000:5000
      - 5056:5056
      - 5681:5678
    volumes:
      - ./gateway:/app/gateway
      - ./webapp:/app/webapp
      - ./scripts:/app/scripts
      - ./workflows:/app/workflows
    environment:
      - IBKR_USERNAME=${IBKR_USERNAME}
      - IBKR_PASSWORD=${IBKR_PASSWORD}
      - IBKR_ACCOUNT_ID=${IBKR_ACCOUNT_ID}
      - NOCODB_API_TOKEN=${NOCODB_API_TOKEN}
      - NOCODB_PROJECT_ID=${NOCODB_PROJECT_ID}
      - NOCODB_TABLE_ID=${NOCODB_TABLE_ID}
      - NOCODB_ORDERS_TABLE_ID=${NOCODB_ORDERS_TABLE_ID}
      - NOCODB_TRADES_TABLE_ID=${NOCODB_TRADES_TABLE_ID}
      - PRICE_ADJUST_BUY_PERCENT=${PRICE_ADJUST_BUY_PERCENT}
      - PRICE_ADJUST_SELL_PERCENT=${PRICE_ADJUST_SELL_PERCENT}
    restart: unless-stopped

  gateway-nginx-proxy:
    container_name: ibkr-gateway-proxy
    image: nginx:stable-alpine
    platform: linux/amd64
    depends_on:
      - ibkr-n8n-combined
    ports:
      - "5055:443"
    volumes:
      - ./webapp/cert.pem:/etc/nginx/certs/cert.pem:ro
      - ./webapp/key.pem:/etc/nginx/certs/key.pem:ro
      - ./gateway-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: always

  n8n-nginx-proxy:
    container_name: ibkr-n8n-proxy
    image: nginx:stable-alpine
    platform: linux/amd64
    depends_on:
      - ibkr-n8n-combined
    ports:
      - "5680:443"
    volumes:
      - ./webapp/cert.pem:/etc/nginx/certs/cert.pem:ro
      - ./webapp/key.pem:/etc/nginx/certs/key.pem:ro
      - ./n8n-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: always

  nocodb-db:
    container_name: ibkr-nocodb-db
    image: postgres:14
    platform: linux/amd64
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=nocodb
    volumes:
      - nocodb-db-data:/var/lib/postgresql/data
    restart: unless-stopped

  nocodb:
    container_name: ibkr-nocodb
    depends_on:
      - nocodb-db
    image: nocodb/nocodb:latest
    platform: linux/amd64
    ports:
      - 5444:8080
    environment:
      - NC_DB=pg://nocodb-db:5432?u=postgres&p=postgres&d=nocodb
      - NC_AUTH_JWT_SECRET=your-jwt-secret
      - NC_PUBLIC_URL=https://localhost:5443
    restart: unless-stopped

  nocodb-nginx-proxy:
    container_name: ibkr-nocodb-proxy
    image: nginx:stable-alpine
    platform: linux/amd64
    depends_on:
      - nocodb
    ports:
      - "5443:443"
    volumes:
      - ./webapp/cert.pem:/etc/nginx/certs/cert.pem:ro
      - ./webapp/key.pem:/etc/nginx/certs/key.pem:ro
      - ./nocodb-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: always

  minio:
    container_name: ibkr-minio
    image: minio/minio
    platform: linux/amd64
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - minio-data:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    command: server --console-address ":9001" /data
    restart: unless-stopped

  flowise:
    container_name: ibkr-flowise
    image: flowiseai/flowise:latest
    platform: linux/amd64
    ports:
      - 3000:3000
    volumes:
      - flowise-data:/root/.flowise
    environment:
      - USERNAME=${FLOWISE_USERNAME}
      - PASSWORD=${FLOWISE_PASSWORD}
      - PORT=3000
      - DATABASE_PATH=/root/.flowise
      - APIKEY_PATH=/root/.flowise
    restart: unless-stopped

  flowise-nginx-proxy:
    container_name: ibkr-flowise-proxy
    image: nginx:stable-alpine
    platform: linux/amd64
    depends_on:
      - flowise
    ports:
      - "9444:443"
    volumes:
      - ./webapp/cert.pem:/etc/nginx/certs/cert.pem:ro
      - ./webapp/key.pem:/etc/nginx/certs/key.pem:ro
      - ./flowise-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: always

volumes:
  nocodb-db-data:
  minio-data:
  flowise-data: 