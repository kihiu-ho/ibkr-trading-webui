{% extends "base.html" %}

{% block title %}Trading Signals - LLM Chart Analysis{% endblock %}

{% block content %}
<div x-data="signalPage()" x-init="init()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Trading Signals</h1>
        <p class="text-gray-600">AI-powered trading signals from multi-timeframe chart analysis</p>
    </div>

    <!-- Generate Signal Form -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Generate Signal</h2>
        
        <form @submit.prevent="generateSignal" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Symbol Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Symbol</label>
                    <input 
                        type="text" 
                        x-model="form.symbol" 
                        placeholder="e.g. TSLA, NVDA" 
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>

                <!-- Timeframes Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Timeframes</label>
                    <select 
                        x-model="form.timeframes" 
                        multiple
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="1d" selected>Daily (1d)</option>
                        <option value="1w" selected>Weekly (1w)</option>
                        <option value="1M">Monthly (1M)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Hold Cmd/Ctrl to select multiple</p>
                </div>

            </div>

            <!-- Advanced Options -->
            <div class="flex items-center space-x-4">
                <label class="flex items-center">
                    <input type="checkbox" x-model="form.force_regenerate" class="mr-2">
                    <span class="text-sm text-gray-700">Force Regenerate (ignore cache)</span>
                </label>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-between items-center">
                <button 
                    type="submit" 
                    :disabled="loading"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center"
                >
                    <svg x-show="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span x-text="loading ? 'Analyzing...' : 'Generate Signal'"></span>
                </button>

                <div x-show="estimatedCost" class="text-sm text-gray-600">
                    Estimated cost: <span class="font-semibold" x-text="estimatedCost"></span>
                </div>
            </div>
        </form>

        <!-- Error Message -->
        <div x-show="error" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-800" x-text="error"></p>
        </div>
    </div>

    <!-- Signal Display -->
    <div x-show="signal" class="space-y-6">
        <!-- Summary Card -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-2xl font-bold mb-2" x-text="signal?.symbol"></h3>
                    <p class="text-blue-100" x-text="formatDate(signal?.generated_at)"></p>
                </div>
                <div class="text-right">
                    <div 
                        class="inline-block px-4 py-2 rounded-lg font-bold text-lg"
                        :class="{
                            'bg-green-500': signal?.signal_type === 'BUY',
                            'bg-red-500': signal?.signal_type === 'SELL',
                            'bg-yellow-500': signal?.signal_type === 'HOLD'
                        }"
                        x-text="signal?.signal_type"
                    ></div>
                    <p class="mt-2 text-blue-100">
                        Confidence: <span class="font-semibold" x-text="(signal?.confidence * 100)?.toFixed(0) + '%'"></span>
                    </p>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <p class="text-blue-200 text-sm">Trend</p>
                    <p class="font-semibold capitalize" x-text="signal?.trend?.replace('_', ' ')"></p>
                </div>
                <div>
                    <p class="text-blue-200 text-sm">Entry Range</p>
                    <p class="font-semibold" x-text="`$${signal?.entry_price_low?.toFixed(2)} - $${signal?.entry_price_high?.toFixed(2)}`"></p>
                </div>
                <div>
                    <p class="text-blue-200 text-sm">Stop Loss</p>
                    <p class="font-semibold" x-text="`$${signal?.stop_loss?.toFixed(2)}`"></p>
                </div>
                <div>
                    <p class="text-blue-200 text-sm">Position Size</p>
                    <p class="font-semibold" x-text="`${signal?.position_size_percent?.toFixed(1)}%`"></p>
                </div>
            </div>
        </div>

        <!-- Charts Display -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Technical Charts</h3>
                <button @click="chartsVisible = !chartsVisible" class="text-blue-600 hover:text-blue-700">
                    <span x-text="chartsVisible ? 'Hide Charts' : 'Show Charts'"></span>
                </button>
            </div>

            <div x-show="chartsVisible" class="space-y-6">
                <!-- Daily Chart -->
                <div>
                    <h4 class="font-semibold mb-2 text-gray-700">Daily Chart (1d)</h4>
                    <div class="border rounded-lg overflow-hidden">
                        <iframe 
                            :src="signal?.chart_html_daily" 
                            class="w-full h-[600px]"
                            frameborder="0"
                        ></iframe>
                    </div>
                    <a 
                        :href="signal?.chart_url_daily" 
                        target="_blank"
                        class="inline-block mt-2 text-sm text-blue-600 hover:text-blue-700"
                    >
                        ðŸ“¥ Download Daily Chart (JPEG)
                    </a>
                </div>

                <!-- Weekly Chart -->
                <div x-show="signal?.chart_html_weekly">
                    <h4 class="font-semibold mb-2 text-gray-700">Weekly Chart (1w)</h4>
                    <div class="border rounded-lg overflow-hidden">
                        <iframe 
                            :src="signal?.chart_html_weekly" 
                            class="w-full h-[600px]"
                            frameborder="0"
                        ></iframe>
                    </div>
                    <a 
                        :href="signal?.chart_url_weekly" 
                        target="_blank"
                        class="inline-block mt-2 text-sm text-blue-600 hover:text-blue-700"
                    >
                        ðŸ“¥ Download Weekly Chart (JPEG)
                    </a>
                </div>
            </div>
        </div>

        <!-- Trading Recommendations -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">Trading Recommendations</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Conservative Target -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-green-700 mb-3">Conservative Target</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Target Price:</span>
                            <span class="font-semibold" x-text="`$${signal?.target_conservative?.toFixed(2)}`"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">R-Multiple:</span>
                            <span class="font-semibold text-green-600" x-text="`${signal?.r_multiple_conservative?.toFixed(2)}R`"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Potential Gain:</span>
                            <span class="font-semibold" x-text="calculateGainPercent(signal?.entry_price_low, signal?.target_conservative)"></span>
                        </div>
                    </div>
                </div>

                <!-- Aggressive Target -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-700 mb-3">Aggressive Target</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Target Price:</span>
                            <span class="font-semibold" x-text="`$${signal?.target_aggressive?.toFixed(2)}`"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">R-Multiple:</span>
                            <span class="font-semibold text-blue-600" x-text="`${signal?.r_multiple_aggressive?.toFixed(2)}R`"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Potential Gain:</span>
                            <span class="font-semibold" x-text="calculateGainPercent(signal?.entry_price_low, signal?.target_aggressive)"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signal Confirmation -->
            <div x-show="signal?.confirmation_signals" class="mt-6">
                <h4 class="font-semibold mb-3">Signal Confirmation (3/4 Rule)</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div :class="signal?.confirmation_signals?.supertrend ? 'text-green-600' : 'text-gray-400'">
                        âœ“ SuperTrend
                    </div>
                    <div :class="signal?.confirmation_signals?.price_vs_ma20 ? 'text-green-600' : 'text-gray-400'">
                        âœ“ Price vs MA20
                    </div>
                    <div :class="signal?.confirmation_signals?.macd ? 'text-green-600' : 'text-gray-400'">
                        âœ“ MACD Cross
                    </div>
                    <div :class="signal?.confirmation_signals?.rsi ? 'text-green-600' : 'text-gray-400'">
                        âœ“ RSI Position
                    </div>
                </div>
                <p class="mt-2 text-sm">
                    <span class="font-semibold" x-text="signal?.confirmation_signals?.confirmed_count"></span> / 4 signals confirmed
                    <span 
                        class="ml-2 px-2 py-1 rounded text-xs font-semibold"
                        :class="signal?.confirmation_signals?.passed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                        x-text="signal?.confirmation_signals?.passed ? 'PASSED' : 'PARTIAL'"
                    ></span>
                </p>
            </div>
        </div>

        <!-- Analysis Report -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Detailed Analysis</h3>
                <button @click="analysisVisible = !analysisVisible" class="text-blue-600 hover:text-blue-700">
                    <span x-text="analysisVisible ? 'Hide Analysis' : 'Show Analysis'"></span>
                </button>
            </div>

            <div x-show="analysisVisible" class="space-y-4">
                <!-- Consolidated Analysis -->
                <div x-show="signal?.analysis_consolidated">
                    <h4 class="font-semibold text-gray-700 mb-2">Consolidated Analysis</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <pre class="whitespace-pre-wrap text-sm text-gray-800" x-text="signal?.analysis_consolidated"></pre>
                    </div>
                </div>

                <!-- Daily Analysis -->
                <div x-show="signal?.analysis_daily">
                    <h4 class="font-semibold text-gray-700 mb-2">Daily Chart Analysis</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <pre class="whitespace-pre-wrap text-sm text-gray-800" x-text="signal?.analysis_daily"></pre>
                    </div>
                </div>

                <!-- Weekly Analysis -->
                <div x-show="signal?.analysis_weekly">
                    <h4 class="font-semibold text-gray-700 mb-2">Weekly Chart Analysis</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <pre class="whitespace-pre-wrap text-sm text-gray-800" x-text="signal?.analysis_weekly"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metadata -->
        <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600">
            <div class="flex justify-between">
                <span>Model: <span class="font-mono" x-text="signal?.model_used"></span></span>
                <span>Provider: <span class="font-semibold" x-text="signal?.provider"></span></span>
                <span>Expires: <span x-text="formatDate(signal?.expires_at)"></span></span>
            </div>
        </div>
    </div>

    <!-- Signal History -->
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-semibold mb-4">Recent Signals</h3>
        
        <div x-show="history.length === 0" class="text-gray-500 text-center py-8">
            No signal history yet. Generate your first signal above.
        </div>

        <div class="overflow-x-auto">
            <table x-show="history.length > 0" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Symbol</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Signal</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Confidence</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entry</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Target</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">R-Multiple</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Generated</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="item in history" :key="item.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 font-semibold" x-text="item.symbol"></td>
                            <td class="px-4 py-3">
                                <span 
                                    class="px-2 py-1 rounded text-xs font-semibold"
                                    :class="{
                                        'bg-green-100 text-green-800': item.signal_type === 'BUY',
                                        'bg-red-100 text-red-800': item.signal_type === 'SELL',
                                        'bg-yellow-100 text-yellow-800': item.signal_type === 'HOLD'
                                    }"
                                    x-text="item.signal_type"
                                ></span>
                            </td>
                            <td class="px-4 py-3" x-text="(item.confidence * 100)?.toFixed(0) + '%'"></td>
                            <td class="px-4 py-3 text-sm" x-text="`$${item.entry_price_low?.toFixed(2)}`"></td>
                            <td class="px-4 py-3 text-sm" x-text="`$${item.target_conservative?.toFixed(2)}`"></td>
                            <td class="px-4 py-3 text-sm font-semibold text-green-600" x-text="`${item.r_multiple_conservative?.toFixed(2)}R`"></td>
                            <td class="px-4 py-3 text-sm text-gray-500" x-text="formatDate(item.generated_at)"></td>
                            <td class="px-4 py-3">
                                <button 
                                    @click="loadSignal(item)"
                                    class="text-blue-600 hover:text-blue-700 text-sm font-medium"
                                >
                                    View
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function signalPage() {
    return {
        form: {
            symbol: '',
            timeframes: ['1d', '1w'],
            force_regenerate: false
        },
        signal: null,
        history: [],
        loading: false,
        error: null,
        chartsVisible: true,
        analysisVisible: false,
        estimatedCost: '$0.03 - $0.07',

        async init() {
            await this.loadHistory();
        },

        async generateSignal() {
            this.loading = true;
            this.error = null;

            try {
                const response = await fetch('/api/signals/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.form)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate signal');
                }

                this.signal = await response.json();
                await this.loadHistory();
            } catch (err) {
                this.error = err.message;
                console.error('Error generating signal:', err);
            } finally {
                this.loading = false;
            }
        },

        async loadHistory() {
            try {
                const response = await fetch('/api/signals/history/all?limit=10');
                if (response.ok) {
                    this.history = await response.json();
                }
            } catch (err) {
                console.error('Error loading history:', err);
            }
        },

        loadSignal(item) {
            this.signal = item;
            this.chartsVisible = true;
            this.analysisVisible = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        calculateGainPercent(entry, target) {
            if (!entry || !target) return 'N/A';
            const gain = ((target - entry) / entry * 100).toFixed(2);
            return `${gain > 0 ? '+' : ''}${gain}%`;
        }
    };
}
</script>
{% endblock %}

