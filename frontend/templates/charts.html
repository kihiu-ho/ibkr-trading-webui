{% extends "base.html" %}

{% block title %}Technical Analysis Charts{% endblock %}

{% block content %}
<div x-data="chartsPage()" x-init="init()" class="p-6">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Technical Analysis Charts</h1>
            <p class="text-gray-600 mt-1">Generate and view technical analysis charts with multiple indicators</p>
        </div>
        <button @click="showGenerateModal = true" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Generate Chart
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Symbol</label>
                <input type="text" x-model="filters.symbol" @input="loadCharts()" 
                    placeholder="e.g., AAPL" 
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Strategy</label>
                <select x-model="filters.strategy_id" @change="loadCharts()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Strategies</option>
                    <template x-for="strategy in availableStrategies" :key="strategy.id">
                        <option :value="strategy.id" x-text="strategy.name"></option>
                    </template>
                </select>
            </div>
            <div class="flex items-end">
                <button @click="clearFilters()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">
                    Clear Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="text-gray-600 mt-4">Loading charts...</p>
    </div>

    <!-- Charts Gallery -->
    <div x-show="!loading && charts.length > 0" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        <template x-for="chart in charts" :key="chart.id">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                <!-- Chart Image Preview -->
                <div class="relative h-64 bg-gray-100">
                    <img :src="chart.chart_url_jpeg" 
                         :alt="`${chart.symbol} Chart`"
                         class="w-full h-full object-cover cursor-pointer"
                         @click="viewChart(chart)"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect width=%22400%22 height=%22300%22 fill=%22%23f3f4f6%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial,sans-serif%22 font-size=%2218%22 fill=%22%236b7280%22%3EChart Preview%3C/text%3E%3C/svg%3E'">
                    <div class="absolute top-2 right-2 bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-semibold" x-text="chart.symbol"></div>
                </div>

                <!-- Chart Info -->
                <div class="p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-lg text-gray-900" x-text="chart.symbol"></h3>
                            <p class="text-sm text-gray-600" x-text="`${chart.period} points @ ${chart.frequency}`"></p>
                        </div>
                        <span class="text-xs text-gray-500" x-text="formatDate(chart.generated_at)"></span>
                    </div>

                    <!-- Indicators Used -->
                    <div class="mb-3">
                        <p class="text-sm font-medium text-gray-700 mb-1">Indicators:</p>
                        <div class="flex flex-wrap gap-1">
                            <template x-for="name in chart.metadata?.indicator_names || []" :key="name">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded" x-text="name"></span>
                            </template>
                        </div>
                    </div>

                    <!-- Metadata -->
                    <div class="text-xs text-gray-500 mb-3">
                        <span x-text="`JPEG: ${Math.round(chart.metadata?.jpeg_size_kb || 0)}KB`"></span>
                        <span class="mx-2">â€¢</span>
                        <span x-text="`HTML: ${Math.round(chart.metadata?.html_size_kb || 0)}KB`"></span>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2">
                        <button @click="viewChart(chart)" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                            View
                        </button>
                        <a :href="chart.chart_url_jpeg" download class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm text-center">
                            Download
                        </a>
                        <button @click="deleteChart(chart.id)" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && charts.length === 0" class="text-center py-12">
        <svg class="mx-auto h-24 w-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        <h3 class="mt-4 text-lg font-medium text-gray-900">No charts found</h3>
        <p class="mt-2 text-gray-600">Generate your first technical analysis chart to get started.</p>
        <button @click="showGenerateModal = true" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
            Generate Chart
        </button>
    </div>

    <!-- Generate Chart Modal -->
    <div x-show="showGenerateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" @click.self="showGenerateModal = false">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" @click.stop>
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Generate Technical Analysis Chart</h2>
                
                <form @submit.prevent="generateChart()">
                    <!-- Symbol -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Symbol *</label>
                        <input type="text" x-model="generateForm.symbol" required
                            placeholder="e.g., AAPL" 
                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Period and Frequency -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Points *</label>
                            <input type="number" x-model.number="generateForm.period" required min="20" max="500"
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">20-500 data points</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Frequency *</label>
                            <select x-model="generateForm.frequency" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="1m">1 Minute</option>
                                <option value="5m">5 Minutes</option>
                                <option value="15m">15 Minutes</option>
                                <option value="30m">30 Minutes</option>
                                <option value="1h">1 Hour</option>
                                <option value="4h">4 Hours</option>
                                <option value="1D" selected>1 Day</option>
                                <option value="1W">1 Week</option>
                                <option value="1M">1 Month</option>
                            </select>
                        </div>
                    </div>

                    <!-- Strategy (Optional) -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Associated Strategy (Optional)</label>
                        <select x-model="generateForm.strategy_id" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">None</option>
                            <template x-for="strategy in availableStrategies" :key="strategy.id">
                                <option :value="strategy.id" x-text="strategy.name"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Indicators Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Indicators *</label>
                        <div class="border rounded-lg p-3 max-h-64 overflow-y-auto">
                            <template x-for="indicator in availableIndicators" :key="indicator.id">
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" 
                                        :value="indicator.id" 
                                        x-model="generateForm.indicator_ids"
                                        class="mr-3 w-4 h-4 text-blue-600">
                                    <div class="flex-1">
                                        <div class="font-medium" x-text="indicator.name"></div>
                                        <div class="text-xs text-gray-500" x-text="`${indicator.type} - ${indicator.period} points @ ${indicator.frequency}`"></div>
                                    </div>
                                </label>
                            </template>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">
                            Selected: <span x-text="generateForm.indicator_ids.length"></span> indicator(s)
                        </p>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button type="button" @click="showGenerateModal = false" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">
                            Cancel
                        </button>
                        <button type="submit" :disabled="generating || generateForm.indicator_ids.length === 0" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!generating">Generate Chart</span>
                            <span x-show="generating">Generating...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Chart Modal -->
    <div x-show="viewingChart" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50" @click.self="viewingChart = null">
        <div class="relative w-full h-full flex items-center justify-center">
            <button @click="viewingChart = null" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <template x-if="viewingChart">
                <div class="max-w-7xl max-h-full overflow-auto bg-white rounded-lg p-4">
                    <iframe :src="viewingChart.chart_url_html" class="w-full h-screen border-0"></iframe>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
function chartsPage() {
    return {
        charts: [],
        availableStrategies: [],
        availableIndicators: [],
        loading: false,
        generating: false,
        showGenerateModal: false,
        viewingChart: null,
        filters: {
            symbol: '',
            strategy_id: ''
        },
        generateForm: {
            symbol: '',
            period: 100,
            frequency: '1D',
            strategy_id: '',
            indicator_ids: []
        },

        async init() {
            await this.loadStrategies();
            await this.loadIndicators();
            await this.loadCharts();
        },

        async loadCharts() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                if (this.filters.symbol) params.append('symbol', this.filters.symbol);
                if (this.filters.strategy_id) params.append('strategy_id', this.filters.strategy_id);
                params.append('limit', '50');

                const response = await fetch(`/api/charts?${params}`);
                if (response.ok) {
                    this.charts = await response.json();
                } else {
                    console.error('Failed to load charts');
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            } finally {
                this.loading = false;
            }
        },

        async loadStrategies() {
            try {
                const response = await fetch('/api/strategies');
                if (response.ok) {
                    this.availableStrategies = await response.json();
                }
            } catch (error) {
                console.error('Error loading strategies:', error);
            }
        },

        async loadIndicators() {
            try {
                const response = await fetch('/api/indicators');
                if (response.ok) {
                    this.availableIndicators = await response.json();
                }
            } catch (error) {
                console.error('Error loading indicators:', error);
            }
        },

        async generateChart() {
            if (this.generateForm.indicator_ids.length === 0) {
                alert('Please select at least one indicator');
                return;
            }

            this.generating = true;
            try {
                const payload = {
                    symbol: this.generateForm.symbol.toUpperCase(),
                    period: this.generateForm.period,
                    frequency: this.generateForm.frequency,
                    indicator_ids: this.generateForm.indicator_ids,
                    strategy_id: this.generateForm.strategy_id || null
                };

                const response = await fetch('/api/charts/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const chart = await response.json();
                    this.charts.unshift(chart);
                    this.showGenerateModal = false;
                    this.resetGenerateForm();
                    alert('Chart generated successfully!');
                } else {
                    const error = await response.json();
                    alert(`Failed to generate chart: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error generating chart:', error);
                alert('Error generating chart. Please try again.');
            } finally {
                this.generating = false;
            }
        },

        async deleteChart(chartId) {
            if (!confirm('Are you sure you want to delete this chart?')) return;

            try {
                const response = await fetch(`/api/charts/${chartId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    this.charts = this.charts.filter(c => c.id !== chartId);
                    alert('Chart deleted successfully');
                } else {
                    alert('Failed to delete chart');
                }
            } catch (error) {
                console.error('Error deleting chart:', error);
                alert('Error deleting chart');
            }
        },

        viewChart(chart) {
            this.viewingChart = chart;
        },

        clearFilters() {
            this.filters.symbol = '';
            this.filters.strategy_id = '';
            this.loadCharts();
        },

        resetGenerateForm() {
            this.generateForm = {
                symbol: '',
                period: 100,
                frequency: '1D',
                strategy_id: '',
                indicator_ids: []
            };
        },

        formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
    };
}
</script>
{% endblock %}

