{% extends "base.html" %}

{% block title %}Technical Indicators - IBKR Trading{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="indicatorManager()">
    <!-- Header -->
    <div class="sm:flex sm:items-center mb-8">
        <div class="sm:flex-auto">
            <h1 class="text-2xl font-semibold text-gray-900">Technical Indicators</h1>
            <p class="mt-2 text-sm text-gray-700">Manage and configure technical indicators for your strategies</p>
        </div>
        <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
            <button @click="showCreateModal = true" class="inline-flex items-center justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                <i class="fa fa-plus mr-2"></i>
                Add Indicator
            </button>
        </div>
    </div>

    <!-- Indicators Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parameters</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="indicator in indicators" :key="indicator.id">
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900" x-text="indicator.name"></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800" x-text="indicator.type"></span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            <span x-text="formatParameters(indicator.parameters)"></span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(indicator.created_at)"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button @click="editIndicator(indicator)" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button @click="deleteIndicator(indicator.id)" class="text-red-600 hover:text-red-900">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                </template>
                <tr x-show="indicators.length === 0">
                    <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                        No indicators found. Click "Add Indicator" to create one.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Create/Edit Modal -->
    <div x-show="showCreateModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 z-50 flex items-center justify-center" x-cloak>
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900" x-text="editingIndicator ? 'Edit Indicator' : 'Create Indicator'"></h3>
            </div>
            <form @submit.prevent="saveIndicator()" class="px-6 py-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Indicator Name *</label>
                        <input x-model="formData.name" type="text" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Indicator Type *</label>
                        <select x-model="formData.type" @change="updateParameterForm()" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="">Select type...</option>
                            <template x-for="template in templates" :key="template.type">
                                <option :value="template.type" x-text="template.name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <!-- Dynamic Parameter Fields -->
                    <div x-show="formData.type" class="border-t pt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Parameters</h4>
                        <div class="space-y-3" x-html="parameterFieldsHTML"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-x-3">
                    <button type="button" @click="closeModal()" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('indicatorManager', () => ({
        indicators: [],
        templates: [],
        showCreateModal: false,
        editingIndicator: null,
        formData: {
            name: '',
            type: '',
            parameters: {}
        },
        parameterFieldsHTML: '',

        async init() {
            await this.loadIndicators();
            await this.loadTemplates();
        },

        async loadIndicators() {
            try {
                const response = await fetch('/api/indicators');
                if (response.ok) {
                    this.indicators = await response.json();
                }
            } catch (error) {
                console.error('Failed to load indicators:', error);
            }
        },

        async loadTemplates() {
            try {
                const response = await fetch('/api/indicators/templates');
                if (response.ok) {
                    this.templates = await response.json();
                }
            } catch (error) {
                console.error('Failed to load templates:', error);
            }
        },

        updateParameterForm() {
            const template = this.templates.find(t => t.type === this.formData.type);
            if (!template) {
                this.parameterFieldsHTML = '';
                this.formData.parameters = {};
                return;
            }

            // Initialize parameters with defaults
            this.formData.parameters = {...template.default_parameters};

            // Generate HTML for parameter fields
            let html = '';
            for (const [key, schema] of Object.entries(template.parameter_schema)) {
                const value = this.formData.parameters[key] || '';
                
                if (schema.enum) {
                    html += `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${key}</label>
                            <select 
                                x-model="formData.parameters.${key}"
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                            >
                                ${schema.enum.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                            <p class="mt-1 text-xs text-gray-500">${schema.description || ''}</p>
                        </div>
                    `;
                } else {
                    const inputType = schema.type === 'integer' ? 'number' : 'number';
                    const step = schema.type === 'integer' ? '1' : '0.01';
                    html += `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${key}</label>
                            <input 
                                type="${inputType}"
                                x-model.number="formData.parameters.${key}"
                                step="${step}"
                                ${schema.min !== undefined ? `min="${schema.min}"` : ''}
                                ${schema.max !== undefined ? `max="${schema.max}"` : ''}
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                            >
                            <p class="mt-1 text-xs text-gray-500">${schema.description || ''}</p>
                        </div>
                    `;
                }
            }
            this.parameterFieldsHTML = html;
        },

        editIndicator(indicator) {
            this.editingIndicator = indicator;
            this.formData = {
                name: indicator.name,
                type: indicator.type,
                parameters: {...indicator.parameters}
            };
            this.updateParameterForm();
            this.showCreateModal = true;
        },

        async saveIndicator() {
            try {
                const url = this.editingIndicator 
                    ? `/api/indicators/${this.editingIndicator.id}`
                    : '/api/indicators';
                const method = this.editingIndicator ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.formData)
                });
                
                if (response.ok) {
                    await this.loadIndicators();
                    this.closeModal();
                    alert('Indicator saved successfully');
                } else {
                    const error = await response.json();
                    alert(`Failed: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to save indicator:', error);
                alert('Failed to save indicator');
            }
        },

        async deleteIndicator(id) {
            if (!confirm('Delete this indicator?')) return;
            
            try {
                const response = await fetch(`/api/indicators/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await this.loadIndicators();
                    alert('Indicator deleted');
                } else {
                    const error = await response.json();
                    alert(`Failed: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to delete indicator:', error);
            }
        },

        closeModal() {
            this.showCreateModal = false;
            this.editingIndicator = null;
            this.formData = { name: '', type: '', parameters: {} };
            this.parameterFieldsHTML = '';
        },

        formatParameters(params) {
            return Object.entries(params).map(([k, v]) => `${k}=${v}`).join(', ');
        },

        formatDate(date) {
            return new Date(date).toLocaleDateString();
        }
    }));
});
</script>
{% endblock %}

