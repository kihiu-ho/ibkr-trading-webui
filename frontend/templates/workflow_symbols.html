{% extends "base.html" %}

{% block title %}Workflow Symbols{% endblock %}
{% block page_title %}Workflow Symbols{% endblock %}

{% block content %}
<div x-data="workflowSymbols()" x-init="init()" class="space-y-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <p class="text-sm uppercase tracking-widest text-blue-600 font-semibold">Workflow Routing</p>
            <h2 class="text-3xl font-bold text-gray-900 mt-1">Workflow Symbols</h2>
            <p class="text-gray-600 mt-2">Associate tradable symbols with one or more Airflow workflows and capture
                optional execution preferences.</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <button @click="loadSymbols"
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">
                <i class="fa fa-sync mr-2"></i> Refresh
            </button>
            <button @click="openAddModal()"
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md shadow-sm hover:bg-blue-700">
                <i class="fa fa-plus mr-2"></i>
                Add Symbol
            </button>
        </div>
    </div>

    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <div class="p-5 bg-white border border-gray-100 rounded-xl shadow-sm">
            <p class="text-sm text-gray-500">Total Symbols</p>
            <p class="text-3xl font-semibold text-gray-900" x-text="symbols.length"></p>
        </div>
        <div class="p-5 bg-green-50 border border-green-100 rounded-xl shadow-sm">
            <p class="text-sm text-green-700">Symbols With Workflows</p>
            <p class="text-3xl font-semibold text-green-900" x-text="coveredCount"></p>
        </div>
        <div class="p-5 bg-rose-50 border border-rose-100 rounded-xl shadow-sm">
            <p class="text-sm text-rose-700">Unassigned Symbols</p>
            <p class="text-3xl font-semibold text-rose-900" x-text="uncoveredCount"></p>
        </div>
        <div class="p-5 bg-indigo-50 border border-indigo-100 rounded-xl shadow-sm">
            <p class="text-sm text-indigo-700">Unique Workflows Covered</p>
            <p class="text-3xl font-semibold text-indigo-900" x-text="uniqueWorkflowCount"></p>
        </div>
    </div>

    <!-- Inline Add Form Removed -->




    <template x-if="toast">
        <div x-cloak class="rounded-md border p-4 flex gap-3" :class="toastClasses(toast.variant)">
            <div class="flex-shrink-0">
                <i :class="toastIcon(toast.variant)"></i>
            </div>
            <div>
                <p class="text-sm font-medium" x-text="toast.message"></p>
            </div>
        </div>
    </template>

    <div class="bg-white rounded-xl shadow border border-gray-100 overflow-hidden">
        <div
            class="px-6 py-4 border-b border-gray-200 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div class="flex items-center gap-4">
                <h3 class="text-lg font-semibold text-gray-900">Symbol Catalog</h3>
                <span class="px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-600 text-xs font-medium"
                    x-text="`${filteredSymbols.length}`"></span>
            </div>

            <div class="flex flex-col gap-3 md:flex-row md:items-center">
                <div class="flex flex-wrap gap-2">
                    <select class="border-gray-300 rounded-md text-sm py-1.5 pl-3 pr-8" x-model="filters.status"
                        aria-label="Filter by status">
                        <option value="all">All Status</option>
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled</option>
                    </select>
                    <select class="border-gray-300 rounded-md text-sm py-1.5 pl-3 pr-8" x-model="filters.workflow"
                        aria-label="Filter by workflow">
                        <option value="all">All Workflows</option>
                        <template x-for="workflow in workflows" :key="workflow.id">
                            <option :value="workflow.id" x-text="workflow.name"></option>
                        </template>
                    </select>
                    <select class="border-gray-300 rounded-md text-sm py-1.5 pl-3 pr-8" x-model="filters.coverage"
                        aria-label="Filter by coverage">
                        <option value="all">All Coverage</option>
                        <option value="assigned">Has workflows</option>
                        <option value="unassigned">Needs workflows</option>
                    </select>
                </div>
                <div class="relative w-full md:w-64">
                    <input type="search" x-model="filters.search" placeholder="Search..."
                        class="w-full border border-gray-300 rounded-md pl-9 pr-3 py-1.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                    <i class="fa fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                </div>
            </div>
        </div>
        <div x-show="loading" class="p-10 text-center text-gray-500">
            <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Loading symbols…</p>
        </div>
        <div x-show="!loading && error" class="p-10 text-center text-red-600">
            <p class="mb-3">Failed to load symbols.</p>
            <button @click="loadSymbols" class="text-blue-600 hover:underline">Retry</button>
        </div>
        <div x-show="!loading && filteredSymbols.length === 0 && !error" class="p-10 text-center text-gray-500">
            <i class="fa fa-inbox text-4xl mb-3 text-gray-300"></i>
            <p>No symbols match the filters.</p>
        </div>
        <div x-show="!loading && filteredSymbols.length > 0" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Symbol</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Primary Workflow</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Workflows</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Priority</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Status</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="symbol in filteredSymbols" :key="symbol.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="text-sm font-semibold text-gray-900" x-text="symbol.symbol"></div>
                                <div class="text-xs text-gray-500" x-text="symbol.name || '—'"></div>
                            </td>
                            <td class="px-6 py-4">
                                <template x-if="symbol.workflows && symbol.workflows.length">
                                    <div>
                                        <div class="text-sm font-semibold text-gray-900"
                                            x-text="symbol.workflows[0].workflow_name || symbol.workflows[0].workflow_id">
                                        </div>
                                        <div class="text-xs text-gray-500"
                                            x-text="symbol.workflows[0].timezone || 'America/New_York'"></div>
                                        <div class="text-xs text-gray-500"
                                            x-show="symbol.workflows[0].session_start && symbol.workflows[0].session_end"
                                            x-text="`${symbol.workflows[0].session_start} - ${symbol.workflows[0].session_end}`">
                                        </div>
                                    </div>
                                </template>
                                <template x-if="!symbol.workflows || symbol.workflows.length === 0">
                                    <div class="text-xs text-gray-500">No workflows assigned</div>
                                </template>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900">
                                <template x-if="symbol.workflows && symbol.workflows.length">
                                    <div class="flex flex-wrap gap-3">
                                        <template x-for="workflow in symbol.workflows"
                                            :key="workflow.link_id || `${symbol.id}-${workflow.workflow_id}`">
                                            <div class="px-3 py-2 rounded-lg border text-xs space-y-1"
                                                :class="workflow.is_active ? 'bg-blue-50 border-blue-200 text-blue-800' : 'bg-gray-50 border-gray-200 text-gray-600'">
                                                <div class="flex items-center gap-1 font-semibold">
                                                    <span
                                                        x-text="workflow.workflow_name || `Workflow ${workflow.workflow_id}`"></span>
                                                    <span class="text-[10px] font-normal px-1.5 py-0.5 rounded-full"
                                                        :class="workflow.workflow_is_active ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'">
                                                        Airflow <span
                                                            x-text="workflow.workflow_is_active ? 'Enabled' : 'Paused'"></span>
                                                    </span>
                                                </div>
                                                <div class="text-[11px] text-gray-600" x-text="workflow.timezone">
                                                </div>
                                                <div class="text-[11px] text-gray-600"
                                                    x-show="workflow.session_start && workflow.session_end"
                                                    x-text="`${workflow.session_start} - ${workflow.session_end}`">
                                                </div>
                                                <div class="text-[11px] font-semibold"
                                                    :class="workflow.allow_weekend ? 'text-indigo-600' : 'text-gray-400'">
                                                    <i class="fa fa-calendar-week mr-1"></i>
                                                    <span
                                                        x-text="workflow.allow_weekend ? 'Weekends Allowed' : 'Weekdays Only'"></span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="!symbol.workflows || symbol.workflows.length === 0">
                                    <span
                                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-rose-50 text-rose-700">
                                        <i class="fa fa-exclamation-triangle mr-1"></i>
                                        Unassigned
                                    </span>
                                </template>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium text-gray-900" x-text="symbol.priority"></span>
                                    <div class="flex flex-col text-gray-400">
                                        <button @click="changePriority(symbol, 1)" class="hover:text-blue-600"><i
                                                class="fa fa-chevron-up"></i></button>
                                        <button @click="changePriority(symbol, -1)" class="hover:text-blue-600"><i
                                                class="fa fa-chevron-down"></i></button>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 inline-flex text-xs font-semibold rounded-full"
                                    :class="symbol.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'"
                                    x-text="symbol.enabled ? 'Enabled' : 'Disabled'"></span>
                            </td>
                            <td class="px-6 py-4 text-right text-sm font-medium">
                                <div class="flex justify-end gap-2">
                                    <button @click="toggleSymbol(symbol)" class="text-gray-500 hover:text-blue-600"
                                        :title="symbol.enabled ? 'Disable' : 'Enable'">
                                        <i :class="symbol.enabled ? 'fa fa-pause-circle' : 'fa fa-play-circle'"></i>
                                    </button>
                                    <button @click="openEditModal(symbol)" class="text-gray-500 hover:text-blue-600"
                                        title="Edit">
                                        <i class="fa fa-edit"></i>
                                    </button>
                                    <button @click="deleteSymbol(symbol)" class="text-gray-500 hover:text-red-600"
                                        title="Delete">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Unified Add/Edit Modal -->
    <template x-teleport="body">
        <div x-show="showModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
            <div class="fixed inset-0 bg-gray-900 opacity-75" @click="closeModal"></div>
            <div
                class="relative bg-white rounded-lg shadow-xl w-full max-w-6xl mx-4 flex flex-col overflow-hidden"
                style="max-height: 90vh;">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                    <h3 class="text-lg font-semibold text-gray-900"
                        x-text="editingSymbol ? 'Edit Symbol' : 'Add New Symbol'"></h3>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600"><i
                            class="fa fa-times"></i></button>
                </div>

                <form @submit.prevent="saveSymbol" class="flex flex-col flex-1 overflow-hidden">
                    <div class="p-6 space-y-6 overflow-y-auto flex-1">

                        <!-- Symbol Lookup (Add Mode Only) -->
                        <div x-show="!editingSymbol" class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <label class="block text-sm font-medium text-blue-900 mb-2">Symbol Lookup *</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="symbolSearch"
                                    class="flex-1 border-blue-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 uppercase"
                                    placeholder="Enter symbol (e.g., AAPL)" @keyup.enter="searchSymbol()">
                                <button type="button" @click="searchSymbol()" :disabled="searching"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 shadow-sm">
                                    <i class="fa" :class="searching ? 'fa-spinner fa-spin' : 'fa-search'"></i>
                                    <span class="ml-2">Search</span>
                                </button>
                            </div>

                            <!-- Search Results -->
                            <div x-show="searchResults.length > 0"
                                class="mt-2 bg-white border border-gray-200 rounded-md max-h-48 overflow-y-auto shadow-lg">
                                <template x-for="contract in searchResults" :key="contract.conid">
                                    <button type="button" @click="selectContract(contract)"
                                        class="w-full text-left px-4 py-3 hover:bg-blue-50 border-b border-gray-100 last:border-b-0 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="font-semibold text-gray-900" x-text="contract.symbol"></div>
                                                <div class="text-xs text-gray-500" x-text="contract.description"></div>
                                            </div>
                                            <div class="text-xs text-gray-400">
                                                <div>ConID: <span x-text="contract.conid"></span></div>
                                                <div x-text="contract.exchange"></div>
                                            </div>
                                        </div>
                                    </button>
                                </template>
                            </div>
                        </div>

                        <div class="grid gap-6 md:grid-cols-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Symbol</label>
                                <input type="text" x-model="form.symbol" readonly
                                    class="mt-1 w-full border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Display Name</label>
                                <input type="text" x-model="form.name"
                                    class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Priority</label>
                                <input type="number" x-model.number="form.priority"
                                    class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ConID</label>
                                <input type="number" x-model.number="form.conid" readonly
                                    class="mt-1 w-full border-gray-300 rounded-md bg-gray-50 text-gray-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" x-model="form.enabled"
                                        class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500">
                                    <span class="text-sm font-medium text-gray-700">Enabled</span>
                                </label>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-6">
                            <h4 class="text-base font-medium text-gray-900 mb-4">Assigned Workflows</h4>

                            <!-- Workflow Selection -->
                            <div class="flex gap-4 mb-4">
                                <div class="flex-1">
                                    <select x-ref="workflowSelect"
                                        class="w-full border-gray-300 rounded-md shadow-sm text-sm">
                                        <option value="">Select a workflow to add...</option>
                                        <template x-for="wf in workflows" :key="wf.dag_id">
                                            <option :value="wf.dag_id" x-text="wf.name"
                                                :disabled="selectedWorkflows.some(w => w.dag_id === wf.dag_id)">
                                            </option>
                                        </template>
                                    </select>
                                </div>
                                <button type="button"
                                    @click="if($refs.workflowSelect.value) { addWorkflow($refs.workflowSelect.value); $refs.workflowSelect.value = ''; }"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium shadow-sm">
                                    <i class="fa fa-plus mr-1"></i> Add
                                </button>
                            </div>

                            <!-- Selected Workflows List -->
                            <div class="space-y-3">
                                <template x-for="(config, index) in selectedWorkflows" :key="config.dag_id">
                                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                        <div class="flex justify-between items-start mb-4">
                                            <div>
                                                <h5 class="font-medium text-gray-900"
                                                    x-text="getWorkflowName(config.dag_id)"></h5>
                                                <p class="text-xs text-gray-500" x-text="config.dag_id"></p>
                                            </div>
                                            <button type="button" @click="removeWorkflow(index)"
                                                class="text-gray-400 hover:text-red-600">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="md:col-span-2">
                                                <label
                                                    class="block text-xs font-medium text-gray-700 mb-1">Timezone</label>
                                                <select x-model="config.timezone"
                                                    class="block w-full rounded-md border-gray-300 shadow-sm text-sm">
                                                    <option value="America/New_York">America/New_York</option>
                                                    <option value="UTC">UTC</option>
                                                    <option value="Europe/London">Europe/London</option>
                                                    <option value="Asia/Tokyo">Asia/Tokyo</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Session
                                                    Start</label>
                                                <input type="time" x-model="config.session_start"
                                                    class="block w-full rounded-md border-gray-300 shadow-sm text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Session
                                                    End</label>
                                                <input type="time" x-model="config.session_end"
                                                    class="block w-full rounded-md border-gray-300 shadow-sm text-sm">
                                            </div>
                                            <div class="md:col-span-2 flex items-center gap-6 pt-2">
                                                <label class="flex items-center gap-2 text-sm text-gray-700">
                                                    <input type="checkbox" x-model="config.allow_weekend"
                                                        class="rounded border-gray-300 text-blue-600">
                                                    <span>Allow Weekend Execution</span>
                                                </label>
                                                <label class="flex items-center gap-2 text-sm text-gray-700">
                                                    <input type="checkbox" x-model="config.is_active"
                                                        class="rounded border-gray-300 text-blue-600">
                                                    <span>Active</span>
                                                </label>
                                            </div>
                                            <div class="md:col-span-2">
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Schedule
                                                    Interval (Cron)</label>
                                                <input type="text" x-model="config.schedule_interval"
                                                    class="block w-full rounded-md border-gray-300 shadow-sm text-sm font-mono"
                                                    placeholder="0 9 * * *">
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="selectedWorkflows.length === 0"
                                    class="text-center py-8 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">
                                    No workflows assigned. Add one above.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t border-gray-200">
                        <button type="button" @click="closeModal"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Cancel</button>
                        <button type="submit"
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700"
                            :disabled="saving">
                            <i class="fa fa-save mr-2"></i>
                            <span x-text="saving ? 'Saving…' : 'Save Changes'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <script>

        function workflowSymbols() {
            return {
                symbols: [],
                workflows: [],
                loading: true,
                error: null,
                toast: null,
                toastTimeout: null,
                showModal: false,
                // showAddForm: false, // Removed
                modalStep: 1,
                editingSymbol: null,
                saving: false,
                selectedWorkflows: [],
                filters: {
                    status: 'all',
                    workflow: 'all',
                    coverage: 'all',
                    search: ''
                },
                workflowFilters: {
                    search: '',
                    status: 'all'
                },
                form: {
                    symbol: '',
                    name: '',
                    priority: 0,
                    enabled: true,
                    conid: null
                },
                symbolSearch: '',
                searchResults: [],
                searching: false,

                init() {
                    this.loadWorkflows();
                    this.loadSymbols();
                },
                async searchSymbol() {
                    if (!this.symbolSearch || this.symbolSearch.trim() === '') {
                        this.showToast('Please enter a symbol to search', 'error');
                        return;
                    }

                    this.searching = true;
                    this.searchResults = [];

                    try {
                        const response = await fetch(`/api/market/search/${this.symbolSearch.toUpperCase()}`);
                        if (!response.ok) {
                            throw new Error('Search failed');
                        }

                        const data = await response.json();
                        this.searchResults = (data.contracts || []).map(c => ({
                            conid: c.conid,
                            symbol: c.symbol || this.symbolSearch.toUpperCase(),
                            description: c.description || c.companyName || '',
                            exchange: c.exchange || c.primaryExchange || 'SMART'
                        }));

                        if (this.searchResults.length === 0) {
                            this.showToast('No contracts found', 'warning');
                        }
                    } catch (error) {
                        this.showToast('Failed to search symbol: ' + error.message, 'error');
                    } finally {
                        this.searching = false;
                    }
                },
                selectContract(contract) {
                    this.form.symbol = contract.symbol;
                    // Automatically set display name as requested: SYMBOL - Description
                    this.form.name = `${contract.symbol} - ${contract.description}`;
                    this.form.conid = contract.conid;
                    this.symbolSearch = contract.symbol;
                    this.searchResults = [];
                    this.showToast(`Selected ${contract.symbol} (ConID: ${contract.conid})`, 'success');
                },
                clearContract() {
                    this.form.symbol = '';
                    this.form.name = '';
                    this.form.conid = null;
                    this.symbolSearch = '';
                    this.searchResults = [];
                },
                get coveredCount() {
                    return this.symbols.filter((symbol) => (symbol.workflows || []).length > 0).length;
                },
                get uncoveredCount() {
                    return this.symbols.filter((symbol) => (symbol.workflows || []).length === 0).length;
                },
                get uniqueWorkflowCount() {
                    const ids = new Set();
                    this.symbols.forEach((symbol) => {
                        (symbol.workflows || []).forEach((workflow) => ids.add(workflow.workflow_id));
                    });
                    return ids.size;
                },
                get canSaveSymbol() {
                    return this.selectedWorkflows.length > 0
                        && this.selectedWorkflows.some((cfg) => cfg.is_active)
                        && this.selectedWorkflows.every((cfg) => this.isWorkflowConfigValid(cfg));
                },
                isWorkflowConfigValid(config) {
                    const hasStart = Boolean(config.session_start);
                    const hasEnd = Boolean(config.session_end);
                    if (config.json_error) return false;
                    if (hasStart !== hasEnd) return false;
                    if (hasStart && hasEnd && config.session_start >= config.session_end) return false;
                    return true;
                },
                get filteredSymbols() {
                    const term = this.filters.search.trim().toLowerCase();
                    const workflowId = this.filters.workflow === 'all' ? null : Number(this.filters.workflow);
                    return this.symbols.filter((symbol) => {
                        const workflowList = symbol.workflows || [];
                        const hasWorkflows = workflowList.length > 0;
                        const matchesStatus = this.filters.status === 'all'
                            || (this.filters.status === 'enabled' && symbol.enabled)
                            || (this.filters.status === 'disabled' && !symbol.enabled);
                        const matchesWorkflow = !workflowId
                            || workflowList.some((workflow) => workflow.workflow_id === workflowId);
                        const matchesCoverage = this.filters.coverage === 'all'
                            || (this.filters.coverage === 'assigned' && hasWorkflows)
                            || (this.filters.coverage === 'unassigned' && !hasWorkflows);
                        const matchesTerm = !term
                            || symbol.symbol.toLowerCase().includes(term)
                            || (symbol.name || '').toLowerCase().includes(term)
                            || workflowList.some((workflow) => (workflow.workflow_name || '').toLowerCase().includes(term));
                        return matchesStatus && matchesWorkflow && matchesCoverage && matchesTerm;
                    });
                },
                get filteredWorkflows() {
                    const term = this.workflowFilters.search.trim().toLowerCase();
                    return this.workflows.filter((workflow) => {
                        const matchesStatus = this.workflowFilters.status === 'all'
                            || (this.workflowFilters.status === 'active' && workflow.is_active)
                            || (this.workflowFilters.status === 'inactive' && !workflow.is_active);
                        const matchesTerm = !term || (workflow.name || '').toLowerCase().includes(term);
                        return matchesStatus && matchesTerm;
                    });
                },
                async loadWorkflows() {
                    try {
                        const response = await fetch('/api/airflow/dags');
                        if (!response.ok) throw new Error('Failed to load Airflow DAGs');
                        const data = await response.json();

                        // Extract DAGs from Airflow API response
                        const dags = data.dags || [];

                        // Transform Airflow DAGs to workflow format
                        this.workflows = dags
                            .filter(dag => !dag.is_paused) // Only show active (unpaused) DAGs
                            .map(dag => ({
                                id: dag.dag_id, // Use dag_id as the ID
                                name: dag.dag_id.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), // Format name
                                description: dag.description || '',
                                dag_id: dag.dag_id,
                                is_active: !dag.is_paused
                            }));
                    } catch (error) {
                        this.showToast('Failed to load Airflow workflows: ' + error.message, 'error');
                        this.workflows = [];
                    }
                },
                async loadSymbols() {
                    this.loading = true;
                    this.error = null;
                    try {
                        const response = await fetch('/api/workflow-symbols/');
                        if (!response.ok) throw new Error('Failed to fetch symbols');
                        const data = await response.json();
                        this.symbols = data
                            .map((symbol) => ({
                                ...symbol,
                                workflows: (symbol.workflows || []).sort((a, b) => a.priority - b.priority),
                            }))
                            .sort((a, b) => b.priority - a.priority || a.symbol.localeCompare(b.symbol));
                    } catch (err) {
                        this.error = err.message;
                        this.showToast(err.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                openAddModal() {
                    this.resetForm();
                    this.editingSymbol = null;
                    this.showModal = true;
                },
                openEditModal(symbol) {
                    this.editingSymbol = symbol;
                    this.form = {
                        symbol: symbol.symbol,
                        name: symbol.name,
                        priority: symbol.priority,
                        enabled: symbol.enabled,
                        conid: symbol.conid
                    };

                    // Deep copy workflows to avoid modifying original until save
                    this.selectedWorkflows = (symbol.workflows || []).map(w => ({
                        dag_id: w.dag_id || w.workflow_id, // Handle both formats if needed
                        timezone: w.timezone || 'America/New_York',
                        session_start: w.session_start || '',
                        session_end: w.session_end || '',
                        allow_weekend: w.allow_weekend || false,
                        is_active: w.is_active !== undefined ? w.is_active : true,
                        schedule_interval: w.schedule_interval || ''
                    }));

                    this.showModal = true;
                },
                closeModal() {
                    this.showModal = false;
                    this.resetForm();
                    this.editingSymbol = null;
                },
                resetForm() {
                    this.form = {
                        symbol: '',
                        name: '',
                        priority: 0,
                        enabled: true,
                        conid: null
                    };
                    this.selectedWorkflows = [];
                    this.editingSymbol = null;
                },
                toTimeInput(value) {
                    if (!value) return null;
                    return value.slice(0, 5);
                },

                // Helper methods for workflow management
                getWorkflow(dagId) {
                    return this.workflows.find(w => w.dag_id === dagId);
                },
                getWorkflowName(dagId) {
                    const wf = this.getWorkflow(dagId);
                    return wf ? wf.name : dagId;
                },
                getWorkflowDagId(dagId) {
                    return dagId;
                },
                isWorkflowSelected(id) {
                    return this.selectedWorkflows.some(w => w.dag_id === id);
                },
                addWorkflow(workflowOrId) {
                    let workflow = workflowOrId;
                    if (typeof workflowOrId === 'string') {
                        workflow = this.workflows.find(w => w.dag_id === workflowOrId);
                    }
                    if (!workflow || this.isWorkflowSelected(workflow.dag_id)) return;

                    this.selectedWorkflows.push({
                        dag_id: workflow.dag_id,
                        is_active: true,
                        priority: 0,
                        timezone: 'America/New_York',
                        session_start: '09:30',
                        session_end: '16:00',
                        allow_weekend: false,
                        schedule_interval: '0 9 * * *',
                        config_json: '',
                        json_error: null
                    });
                },
                removeWorkflow(index) {
                    this.selectedWorkflows.splice(index, 1);
                },
                validateJson(config) {
                    if (!config.config_json || config.config_json.trim() === '') {
                        config.json_error = null;
                        return;
                    }
                    try {
                        JSON.parse(config.config_json);
                        config.json_error = null;
                    } catch (e) {
                        config.json_error = 'Invalid JSON format';
                    }
                },

                goToNextStep() {
                    if (this.modalStep === 1 && !this.form.symbol) {
                        this.showToast('Symbol is required', 'error');
                        return;
                    }
                    if (this.modalStep === 2 && this.selectedWorkflows.length === 0) {
                        this.showToast('Select at least one workflow', 'error');
                        return;
                    }
                    // Check JSON errors before proceeding
                    if (this.modalStep === 2) {
                        const hasErrors = this.selectedWorkflows.some(w => w.json_error);
                        if (hasErrors) {
                            this.showToast('Please fix JSON errors before proceeding', 'error');
                            return;
                        }
                    }
                    if (this.modalStep < 3) {
                        this.modalStep += 1;
                    }
                },
                goToPreviousStep() {
                    if (this.modalStep > 1) {
                        this.modalStep -= 1;
                    }
                },
                validateSelectedWorkflows() {
                    // This method is no longer used directly, validation is in goToNextStep and saveSymbol.
                    return true;
                },
                buildWorkflowConfig(workflowId) {
                    // This method is no longer used, replaced by direct object creation in addWorkflow.
                    return {};
                },
                hydrateWorkflowConfig(link) {
                    // This method is no longer used, replaced by direct mapping in openModal.
                    return {};
                },
                async saveSymbol() {
                    if (this.selectedWorkflows.length === 0) {
                        this.showToast('Select at least one workflow', 'error');
                        this.modalStep = 2;
                        return;
                    }

                    this.saving = true;
                    try {
                        // Prepare workflows payload
                        const workflowsPayload = this.selectedWorkflows.map(w => {
                            let config = null;
                            if (w.config_json && w.config_json.trim()) {
                                try {
                                    config = JSON.parse(w.config_json);
                                } catch (e) {
                                    throw new Error(`Invalid JSON config for workflow ${w.dag_id}`);
                                }
                            }

                            return {
                                dag_id: w.dag_id,
                                is_active: w.is_active,
                                priority: w.priority,
                                timezone: w.timezone,
                                session_start: w.session_start || null,
                                session_end: w.session_end || null,
                                allow_weekend: w.allow_weekend,
                                schedule_interval: w.schedule_interval || '0 9 * * *',
                                config: config
                            };
                        });

                        const payload = {
                            name: this.form.name,
                            priority: this.form.priority,
                            enabled: this.form.enabled,
                            conid: this.form.conid,
                            workflows: workflowsPayload
                        };

                        let response;
                        if (this.editingSymbol) {
                            response = await fetch(`/api/workflow-symbols/${this.editingSymbol.symbol}`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                        } else {
                            response = await fetch('/api/workflow-symbols/', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ...payload, symbol: this.form.symbol })
                            });
                        }
                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Failed to save symbol');
                        }
                        await this.loadSymbols();
                        this.showToast(`Symbol ${this.editingSymbol ? 'updated' : 'added'} successfully`, 'success');
                        if (this.editingSymbol) {
                            this.closeModal();
                        } else {
                            this.closeModal();
                        }
                    } catch (err) {
                        this.showToast(err.message, 'error');
                    } finally {
                        this.saving = false;
                    }
                },
                async toggleSymbol(symbol) {
                    try {
                        const response = await fetch(`/api/workflow-symbols/${symbol.symbol}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ enabled: !symbol.enabled })
                        });
                        if (!response.ok) throw new Error('Failed to update symbol');
                        await this.loadSymbols();
                        this.showToast(`${symbol.symbol} ${symbol.enabled ? 'disabled' : 'enabled'}`, 'success');
                    } catch (err) {
                        this.showToast(err.message, 'error');
                    }
                },
                async changePriority(symbol, delta) {
                    try {
                        const response = await fetch(`/api/workflow-symbols/${symbol.symbol}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ priority: symbol.priority + delta })
                        });
                        if (!response.ok) throw new Error('Failed to update priority');
                        await this.loadSymbols();
                    } catch (err) {
                        this.showToast(err.message, 'error');
                    }
                },
                async deleteSymbol(symbol) {
                    if (!confirm(`Delete ${symbol.symbol}?`)) return;
                    try {
                        const response = await fetch(`/api/workflow-symbols/${symbol.symbol}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete symbol');
                        await this.loadSymbols();
                        this.showToast(`${symbol.symbol} deleted`, 'success');
                    } catch (err) {
                        this.showToast(err.message, 'error');
                    }
                },
                toastClasses(variant) {
                    switch (variant) {
                        case 'error':
                            return 'bg-red-50 border-red-200 text-red-800';
                        default:
                            return 'bg-green-50 border-green-200 text-green-800';
                    }
                },
                toastIcon(variant) {
                    return variant === 'error' ? 'fa fa-exclamation-circle text-red-500' : 'fa fa-check-circle text-green-500';
                },
                showToast(message, variant = 'success') {
                    if (this.toastTimeout) {
                        clearTimeout(this.toastTimeout);
                    }
                    this.toast = { message, variant };
                    this.toastTimeout = setTimeout(() => {
                        this.toast = null;
                        this.toastTimeout = null;
                    }, 4000);
                }
            };
        }
    </script>

    {% endblock %}
