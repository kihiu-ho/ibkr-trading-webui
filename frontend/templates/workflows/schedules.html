{% extends "base.html" %}

{% block title %}Workflow Schedules{% endblock %}
{% block page_title %}Workflow Schedules{% endblock %}

{% block content %}
<div x-data="scheduleManager()" x-init="init()" class="space-y-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h2 class="text-2xl font-semibold text-gray-900">Strategy Scheduler</h2>
            <p class="text-gray-600">Configure when each IBKR strategy runs through Airflow.</p>
        </div>
        <div class="flex gap-3">
            <button @click="refresh" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <i class="fa fa-sync mr-2"></i> Refresh
            </button>
            <button @click="openCreateModal" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                <i class="fa fa-plus mr-2"></i> New Schedule
            </button>
        </div>
    </div>

    <div x-show="toast" x-cloak class="rounded-md border p-4" :class="toast.variant === 'error' ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'">
        <div class="flex">
            <div class="flex-shrink-0">
                <i :class="toast.variant === 'error' ? 'fa fa-exclamation-circle text-red-500' : 'fa fa-check-circle text-green-500'"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium" :class="toast.variant === 'error' ? 'text-red-800' : 'text-green-800'" x-text="toast.message"></p>
            </div>
        </div>
    </div>

    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-900">Scheduled Strategies</h3>
            <span class="text-sm text-gray-500" x-text="`${schedules.length} total`"></span>
        </div>

        <div x-show="isLoading" class="p-8 flex items-center justify-center text-gray-500">
            <i class="fa fa-spinner fa-spin mr-2"></i> Loading schedules...
        </div>

        <div x-show="!isLoading && schedules.length === 0" class="p-8 text-center text-gray-500">
            <i class="fa fa-clock text-3xl mb-3 text-gray-300"></i>
            <p>No schedules configured yet. Create one to start automated runs.</p>
        </div>

        <div x-show="!isLoading && schedules.length > 0" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strategy</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Workflow</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cron / Timezone</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Run</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Run</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="schedule in schedules" :key="schedule.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900" x-text="schedule.strategy_name || `Strategy #${schedule.strategy_id}`"></div>
                                <div class="text-xs text-gray-500">ID: <span x-text="schedule.strategy_id"></span></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="schedule.workflow_name || `Workflow #${schedule.workflow_id || '—'}`"></div>
                                <div class="text-xs text-gray-500" x-text="schedule.dag_id"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <div class="font-mono" x-text="schedule.cron_expression"></div>
                                <div class="text-xs text-gray-500" x-text="schedule.timezone"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <div x-text="formatDate(schedule.next_run_time) || '—'"></div>
                                <div class="text-xs text-gray-500" x-show="schedule.next_runs_preview?.length">
                                    <span>Next:</span>
                                    <template x-for="run in schedule.next_runs_preview.slice(0,2)" :key="run">
                                        <span class="ml-1" x-text="formatShortDate(run)"></span>
                                    </template>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(schedule.last_run_time) || '—'"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium" :class="schedule.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'">
                                    <span class="h-2 w-2 rounded-full mr-2" :class="schedule.enabled ? 'bg-green-500' : 'bg-gray-400'"></span>
                                    <span x-text="schedule.enabled ? 'Enabled' : 'Paused'"></span>
                                </span>
                                <span class="block text-xs text-yellow-700 mt-1" x-show="schedule.pending_airflow_sync">Awaiting Airflow sync…</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                <button @click="runNow(schedule)" :disabled="!schedule.enabled || runningScheduleId === schedule.id" class="inline-flex items-center px-2 py-1 border border-green-600 text-green-600 rounded hover:bg-green-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fa fa-play mr-1"></i> Run
                                </button>
                                <button @click="openEditModal(schedule)" class="inline-flex items-center px-2 py-1 border border-blue-600 text-blue-600 rounded hover:bg-blue-50">
                                    <i class="fa fa-edit mr-1"></i> Edit
                                </button>
                                <button @click="deleteSchedule(schedule)" class="inline-flex items-center px-2 py-1 border border-red-600 text-red-600 rounded hover:bg-red-50">
                                    <i class="fa fa-trash mr-1"></i>
                                </button>
                                <label class="inline-flex items-center ml-2 text-xs text-gray-600 cursor-pointer">
                                    <input type="checkbox" class="mr-1" :checked="schedule.enabled" @change="toggleSchedule(schedule)">
                                    <span>Enable</span>
                                </label>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div x-show="modalOpen" x-cloak class="fixed z-30 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-900 opacity-50"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle w-full max-w-2xl">
                <div class="bg-white px-6 py-5 border-b border-gray-200 flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900" x-text="isEditing ? 'Edit Schedule' : 'Create Schedule'"></h3>
                        <p class="text-sm text-gray-500" x-text="isEditing ? 'Update cadence for this strategy' : 'Bind a strategy to an Airflow cron schedule'"></p>
                    </div>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-lg"></i>
                    </button>
                </div>
                <form @submit.prevent="submitForm">
                    <div class="px-6 py-5 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Strategy ID</label>
                                <input type="number" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" x-model.number="form.strategy_id" :disabled="isEditing" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Workflow ID</label>
                                <input type="number" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" x-model.number="form.workflow_id" :disabled="isEditing" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Cron Expression</label>
                            <input type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 font-mono" placeholder="0 9 * * 1-5" x-model="form.cron_expression" required>
                            <p class="text-xs text-gray-500 mt-1">Use standard 5-field cron syntax (minute hour day month weekday).</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Timezone</label>
                                <select class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" x-model="form.timezone">
                                    <template x-for="zone in timezoneOptions" :key="zone">
                                        <option :value="zone" x-text="zone"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="flex items-center mt-6">
                                <input id="enabledToggle" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded" x-model="form.enabled">
                                <label for="enabledToggle" class="ml-2 block text-sm text-gray-700">Enabled</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Optional context for this cadence" x-model="form.description"></textarea>
                        </div>
                        <div class="bg-gray-50 border border-dashed border-gray-200 rounded-md p-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">Next run preview</h4>
                            <div class="text-sm text-gray-600" x-text="formPreview()"></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
                        <button type="button" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" @click="closeModal">
                            Cancel
                        </button>
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                            <i class="fa fa-save mr-2"></i>
                            <span x-text="isEditing ? 'Save Changes' : 'Create Schedule'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function scheduleManager() {
    return {
        schedules: [],
        isLoading: false,
        modalOpen: false,
        isEditing: false,
        toast: null,
        runningScheduleId: null,
        form: {
            id: null,
            strategy_id: '',
            workflow_id: '',
            cron_expression: '0 9 * * 1-5',
            timezone: 'America/New_York',
            enabled: true,
            description: ''
        },
        timezoneOptions: [
            'America/New_York',
            'UTC',
            'America/Chicago',
            'America/Los_Angeles',
            'Europe/London',
            'Asia/Tokyo'
        ],
        init() {
            this.loadSchedules();
        },
        async loadSchedules() {
            this.isLoading = true;
            try {
                const response = await fetch('/api/schedules');
                if (!response.ok) throw new Error('Failed to load schedules');
                const data = await response.json();
                this.schedules = data.sort((a, b) => a.strategy_id - b.strategy_id);
            } catch (error) {
                this.showToast(error.message, 'error');
            } finally {
                this.isLoading = false;
            }
        },
        refresh() {
            this.loadSchedules();
        },
        openCreateModal() {
            this.isEditing = false;
            this.form = {
                id: null,
                strategy_id: '',
                workflow_id: '',
                cron_expression: '0 9 * * 1-5',
                timezone: 'America/New_York',
                enabled: true,
                description: ''
            };
            this.modalOpen = true;
        },
        openEditModal(schedule) {
            this.isEditing = true;
            this.form = {
                id: schedule.id,
                strategy_id: schedule.strategy_id,
                workflow_id: schedule.workflow_id,
                cron_expression: schedule.cron_expression,
                timezone: schedule.timezone,
                enabled: schedule.enabled,
                description: schedule.description || ''
            };
            this.modalOpen = true;
        },
        closeModal() {
            this.modalOpen = false;
        },
        async submitForm() {
            const payload = {
                cron_expression: this.form.cron_expression,
                timezone: this.form.timezone,
                enabled: this.form.enabled,
                description: this.form.description
            };
            try {
                let response;
                if (this.isEditing) {
                    response = await fetch(`/api/schedules/${this.form.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                } else {
                    response = await fetch(`/api/workflows/${this.form.workflow_id}/schedule`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            strategy_id: this.form.strategy_id,
                            cron_expression: this.form.cron_expression,
                            timezone: this.form.timezone,
                            enabled: this.form.enabled,
                            description: this.form.description
                        })
                    });
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to save schedule');
                }
                this.showToast(this.isEditing ? 'Schedule updated' : 'Schedule created');
                this.closeModal();
                await this.loadSchedules();
            } catch (error) {
                this.showToast(error.message, 'error');
            }
        },
        async deleteSchedule(schedule) {
            if (!confirm('Delete this schedule?')) return;
            try {
                const response = await fetch(`/api/schedules/${schedule.id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete schedule');
                this.showToast('Schedule deleted');
                await this.loadSchedules();
            } catch (error) {
                this.showToast(error.message, 'error');
            }
        },
        async toggleSchedule(schedule) {
            try {
                const response = await fetch(`/api/schedules/${schedule.id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enabled: !schedule.enabled })
                });
                if (!response.ok) throw new Error('Failed to update schedule state');
                await this.loadSchedules();
            } catch (error) {
                this.showToast(error.message, 'error');
            }
        },
        async runNow(schedule) {
            if (!schedule.enabled) {
                this.showToast('Enable the schedule before running.', 'error');
                return;
            }
            this.runningScheduleId = schedule.id;
            try {
                const response = await fetch(`/api/workflows/${schedule.workflow_id}/run-now`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ strategy_id: schedule.strategy_id })
                });
                if (!response.ok) throw new Error('Failed to trigger Airflow run');
                this.showToast('Run triggered');
            } catch (error) {
                this.showToast(error.message, 'error');
            } finally {
                this.runningScheduleId = null;
            }
        },
        formPreview() {
            if (!this.form.cron_expression) return 'Enter a cron expression to preview.';
            return `Cron: ${this.form.cron_expression} (${this.form.timezone})`;
        },
        formatDate(value) {
            if (!value) return null;
            const date = new Date(value);
            return isNaN(date.getTime()) ? null : date.toLocaleString();
        },
        formatShortDate(value) {
            if (!value) return '';
            const date = new Date(value);
            return isNaN(date.getTime()) ? '' : date.toLocaleString();
        },
        showToast(message, variant = 'success') {
            this.toast = { message, variant };
            setTimeout(() => { this.toast = null; }, 4000);
        }
    };
}
</script>
{% endblock %}
