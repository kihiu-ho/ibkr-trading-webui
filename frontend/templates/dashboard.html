{% extends "base.html" %}

{% block title %}Dashboard - IBKR Trading{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="init()">
    <!-- Stats -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
        <!-- Total Strategies -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fa fa-brain text-3xl text-blue-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Active Strategies</dt>
                            <dd class="text-2xl font-semibold text-gray-900" x-text="stats.active_strategies">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Open Positions -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fa fa-briefcase text-3xl text-green-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Open Positions</dt>
                            <dd class="text-2xl font-semibold text-gray-900" x-text="stats.open_positions">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Orders -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fa fa-shopping-cart text-3xl text-yellow-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Pending Orders</dt>
                            <dd class="text-2xl font-semibold text-gray-900" x-text="stats.pending_orders">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Running Tasks -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fa fa-spinner text-3xl text-purple-500"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Running Tasks</dt>
                            <dd class="text-2xl font-semibold text-gray-900" x-text="stats.running_tasks">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white shadow rounded-lg p-6 mb-8">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <button @click="createStrategy()" class="inline-flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                <i class="fa fa-plus mr-2"></i>
                New Strategy
            </button>
            <button @click="executeWorkflow()" class="inline-flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                <i class="fa fa-play mr-2"></i>
                Run Workflow
            </button>
            <button @click="viewAnalysis()" class="inline-flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700">
                <i class="fa fa-chart-bar mr-2"></i>
                View Analysis
            </button>
            <button @click="refreshData()" class="inline-flex items-center justify-center px-4 py-3 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fa fa-refresh mr-2"></i>
                Refresh Data
            </button>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Recent Decisions -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-5 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Recent Trading Decisions</h2>
            </div>
            <ul class="divide-y divide-gray-200">
                <template x-for="decision in recentDecisions" :key="decision.id">
                    <li class="px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div :class="decision.type === 'buy' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-2.5 py-0.5 rounded text-xs font-medium mr-3">
                                    <span x-text="decision.type.toUpperCase()"></span>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900" x-text="decision.code"></p>
                                    <p class="text-sm text-gray-500" x-text="decision.strategy_name"></p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-medium text-gray-900">$<span x-text="decision.current_price.toFixed(2)"></span></p>
                                <p class="text-xs text-gray-500">R: <span x-text="decision.r_coefficient.toFixed(2)"></span></p>
                            </div>
                        </div>
                    </li>
                </template>
                <li x-show="recentDecisions.length === 0" class="px-6 py-8 text-center text-gray-500">
                    No recent decisions
                </li>
            </ul>
        </div>

        <!-- Active Workflows -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-5 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Active Workflows</h2>
            </div>
            <ul class="divide-y divide-gray-200">
                <template x-for="workflow in activeWorkflows" :key="workflow.id">
                    <li class="px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-900" x-text="workflow.strategy_name"></p>
                                <p class="text-sm text-gray-500" x-text="workflow.code"></p>
                            </div>
                            <div class="flex items-center">
                                <span class="px-2.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <span x-text="workflow.status"></span>
                                </span>
                                <button @click="viewWorkflow(workflow.id)" class="ml-3 text-sm text-blue-600 hover:text-blue-800">
                                    <i class="fa fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </li>
                </template>
                <li x-show="activeWorkflows.length === 0" class="px-6 py-8 text-center text-gray-500">
                    No active workflows
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function dashboard() {
        return {
            stats: {
                active_strategies: 0,
                open_positions: 0,
                pending_orders: 0,
                running_tasks: 0
            },
            recentDecisions: [],
            activeWorkflows: [],
            
            async init() {
                await this.loadStats();
                await this.loadRecentDecisions();
                await this.loadActiveWorkflows();
            },
            
            async loadStats() {
                try {
                    const response = await fetch('/api/dashboard/stats');
                    if (response.ok) {
                        this.stats = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to load stats:', error);
                }
            },
            
            async loadRecentDecisions() {
                try {
                    const response = await fetch('/api/decisions?limit=5');
                    if (response.ok) {
                        this.recentDecisions = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to load decisions:', error);
                }
            },
            
            async loadActiveWorkflows() {
                try {
                    const response = await fetch('/api/workflows/executions?status=running');
                    if (response.ok) {
                        this.activeWorkflows = await response.json();
                    }
                } catch (error) {
                    console.error('Failed to load workflows:', error);
                }
            },
            
            createStrategy() {
                window.location.href = '/strategies/new';
            },
            
            executeWorkflow() {
                window.location.href = '/workflows/execute';
            },
            
            viewAnalysis() {
                window.location.href = '/analysis';
            },
            
            async refreshData() {
                await this.init();
                this.showToast('Data refreshed successfully');
            },
            
            viewWorkflow(id) {
                window.location.href = `/workflows/executions/${id}`;
            },
            
            showToast(message) {
                // Simple toast implementation
                const toast = document.createElement('div');
                toast.className = 'bg-green-500 text-white px-6 py-3 rounded shadow-lg';
                toast.textContent = message;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        };
    }
</script>
{% endblock %}

