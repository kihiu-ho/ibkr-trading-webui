{% extends "base.html" %}

{% block title %}Artifact Detail{% endblock %}
{% block page_title %}Artifact Detail{% endblock %}

{% block content %}
<div x-data="artifactDetailData()" x-init="init()">
    <!-- Loading State -->
    <div x-show="loading" class="flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <!-- Error State -->
    <div x-show="error && !loading" class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
        <div class="flex items-center">
            <i class="fa fa-exclamation-triangle text-red-600 text-2xl mr-3"></i>
            <div>
                <h3 class="text-red-900 font-semibold">Error Loading Artifact</h3>
                <p class="text-red-700 text-sm mt-1" x-text="error"></p>
            </div>
        </div>
        <a href="/artifacts" class="mt-4 inline-block text-blue-600 hover:text-blue-800 text-sm font-medium">
            ‚Üê Back to Artifacts
        </a>
    </div>

    <!-- Artifact Detail -->
    <div x-show="!loading && !error && artifact" class="space-y-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-x-3 mb-2">
                        <i class="fa text-2xl" 
                           :class="{
                               'fa-flask text-pink-600': artifact.type === 'llm',
                               'fa-chart-bar text-indigo-600': artifact.type === 'chart',
                               'fa-signal text-purple-600': artifact.type === 'signal'
                           }"></i>
                        <h2 class="text-2xl font-bold text-gray-900" x-text="artifact.name"></h2>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <span x-text="artifact.type?.toUpperCase()"></span>
                        </span>
                        <span x-show="artifact.symbol" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fa fa-chart-line mr-1"></i>
                            <span x-text="artifact.symbol"></span>
                        </span>
                        <span x-show="artifact.dag_id" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-cyan-100 text-cyan-800">
                            <i class="fa fa-wind mr-1"></i>
                            <span x-text="artifact.dag_id"></span>
                        </span>
                        <span x-show="artifact.step_name" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            <i class="fa fa-tasks mr-1"></i>
                            <span x-text="artifact.step_name"></span>
                        </span>
                    </div>
                </div>
                <a href="/artifacts" class="text-gray-600 hover:text-gray-900 text-sm font-medium">
                    <i class="fa fa-arrow-left mr-1"></i> Back
                </a>
            </div>
        </div>

        <!-- Workflow Context (if available) -->
        <div x-show="artifact.workflow_id || artifact.execution_id" class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fa fa-sitemap mr-2 text-gray-600"></i>Workflow Context
            </h3>
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div x-show="artifact.workflow_id">
                    <dt class="text-sm font-medium text-gray-500">Workflow ID</dt>
                    <dd class="mt-1 text-sm text-gray-900 font-mono" x-text="artifact.workflow_id"></dd>
                </div>
                <div x-show="artifact.execution_id">
                    <dt class="text-sm font-medium text-gray-500">Execution ID</dt>
                    <dd class="mt-1 text-sm text-gray-900 font-mono text-xs" x-text="artifact.execution_id"></dd>
                </div>
                <div x-show="artifact.dag_id">
                    <dt class="text-sm font-medium text-gray-500">DAG ID</dt>
                    <dd class="mt-1 text-sm text-gray-900" x-text="artifact.dag_id"></dd>
                </div>
                <div x-show="artifact.task_id">
                    <dt class="text-sm font-medium text-gray-500">Task ID</dt>
                    <dd class="mt-1 text-sm text-gray-900" x-text="artifact.task_id"></dd>
                </div>
                <div x-show="artifact.run_id">
                    <dt class="text-sm font-medium text-gray-500">MLflow Run ID</dt>
                    <dd class="mt-1 text-sm text-gray-900 font-mono text-xs" x-text="artifact.run_id"></dd>
                </div>
                <div x-show="artifact.created_at">
                    <dt class="text-sm font-medium text-gray-500">Created</dt>
                    <dd class="mt-1 text-sm text-gray-900" x-text="new Date(artifact.created_at).toLocaleString()"></dd>
                </div>
            </dl>
        </div>

        <!-- LLM Artifact -->
        <div x-show="artifact.type === 'llm'" class="space-y-6">
            <!-- Model Information -->
            <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fa fa-robot mr-2 text-pink-600"></i>LLM Analysis
            </h3>
            
                <div x-show="artifact.model_name" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-medium text-blue-700">Model:</span>
                            <span class="ml-2 text-sm text-blue-900 font-mono" x-text="artifact.model_name"></span>
                        </div>
                        <div class="text-xs text-blue-600">
                            <span x-text="artifact.prompt_length || 0"></span> / <span x-text="artifact.response_length || 0"></span> chars
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fa fa-arrow-right mr-2 text-green-600"></i>Input (Prompt)
                    </h3>
                    <button 
                        @click="
                            const text = artifact.prompt || '';
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                navigator.clipboard.writeText(text).then(() => {
                                    $el.innerHTML = '<i class=\'fa fa-check mr-1\'></i>Copied!';
                                    setTimeout(() => $el.innerHTML = '<i class=\'fa fa-copy mr-1\'></i>Copy', 2000);
                                }).catch(() => {
                                    $el.innerHTML = '<i class=\'fa fa-exclamation-triangle mr-1\'></i>Failed';
                                    setTimeout(() => $el.innerHTML = '<i class=\'fa fa-copy mr-1\'></i>Copy', 2000);
                                });
                            }
                        " 
                        class="text-sm text-gray-600 hover:text-gray-900 px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50"
                        x-show="artifact.prompt">
                        <i class="fa fa-copy mr-1"></i>Copy
                    </button>
                </div>
                <div class="bg-green-50 rounded-lg p-4 border-2 border-green-200">
                    <div x-show="artifact.prompt" class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed max-h-96 overflow-y-auto" x-text="artifact.prompt"></div>
                    <div x-show="!artifact.prompt" class="text-sm text-gray-500 italic">No prompt available</div>
                    <div class="mt-3 pt-3 border-t border-green-200 text-xs text-gray-600" x-show="artifact.prompt_length">
                        <span class="font-medium">Length:</span> <span x-text="artifact.prompt_length || 0"></span> characters
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fa fa-arrow-left mr-2 text-blue-600"></i>Output (Response)
                    </h3>
                    <button 
                        @click="
                            const text = artifact.response || '';
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                navigator.clipboard.writeText(text).then(() => {
                                    $el.innerHTML = '<i class=\'fa fa-check mr-1\'></i>Copied!';
                                    setTimeout(() => $el.innerHTML = '<i class=\'fa fa-copy mr-1\'></i>Copy', 2000);
                                }).catch(() => {
                                    $el.innerHTML = '<i class=\'fa fa-exclamation-triangle mr-1\'></i>Failed';
                                    setTimeout(() => $el.innerHTML = '<i class=\'fa fa-copy mr-1\'></i>Copy', 2000);
                                });
                            }
                        " 
                        class="text-sm text-gray-600 hover:text-gray-900 px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-50"
                        x-show="artifact.response">
                        <i class="fa fa-copy mr-1"></i>Copy
                    </button>
                </div>
                <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
                    <div x-show="artifact.response" class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed max-h-96 overflow-y-auto" x-text="artifact.response"></div>
                    <div x-show="!artifact.response" class="text-sm text-gray-500 italic">No response available</div>
                    <div class="mt-3 pt-3 border-t border-blue-200 text-xs text-gray-600" x-show="artifact.response_length">
                        <span class="font-medium">Length:</span> <span x-text="artifact.response_length || 0"></span> characters
                    </div>
                </div>
            </div>

            <!-- Metadata Section -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fa fa-info-circle mr-2 text-gray-600"></i>Metadata
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs font-medium text-gray-500">Prompt Length</div>
                        <div class="mt-1 text-lg font-semibold text-gray-900" x-text="artifact.prompt_length || 'N/A'"></div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs font-medium text-gray-500">Response Length</div>
                        <div class="mt-1 text-lg font-semibold text-gray-900" x-text="artifact.response_length || 'N/A'"></div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs font-medium text-gray-500">Total Tokens</div>
                        <div class="mt-1 text-lg font-semibold text-gray-900" x-text="(artifact.prompt_length || 0) + (artifact.response_length || 0)"></div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs font-medium text-gray-500">Model</div>
                        <div class="mt-1 text-sm font-semibold text-gray-900 truncate" x-text="artifact.model_name || 'N/A'"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Artifact -->
        <div x-show="artifact.type === 'chart'" class="space-y-6">
            <!-- Chart Image Section -->
            <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fa fa-chart-line mr-2 text-indigo-600"></i>Chart Image
            </h3>
            
                <div x-show="artifact.image_path || (artifact.chart_data && artifact.chart_data.minio_url)" class="mb-4">
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200" x-data="chartImageViewerState()" x-init="init()" x-effect="syncWithArtifact(artifact)">
                        <div class="mb-3">
                            <div x-show="imageLoading" class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="text-sm text-gray-500 mt-2">Regenerating chart image...</p>
                            </div>
                            <img 
                                x-show="!imageError && currentSrc"
                                :src="currentSrc || ('/api/artifacts/' + artifact.id + '/image')"
                                :alt="artifact.name || 'Chart'" 
                                class="rounded-lg w-full max-w-4xl border border-gray-300 mx-auto"
                                @load="onImageLoad"
                                @error="onImageError"
                                x-cloak
                                crossorigin="anonymous"
                            />
                            <div x-show="htmlFallback" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-800">
                                <i class="fa fa-code mr-2"></i>
                                Plotly saved this artifact as interactive HTML because Kaleido was offline.
                                <span class="text-xs block mt-1">Path: <span class="font-mono break-all" x-text="artifact.image_path"></span></span>
                                <div class="mt-3 flex flex-wrap gap-3 items-center">
                                    <button @click="showEmbeddedHtml = !showEmbeddedHtml" class="px-3 py-1 text-xs font-semibold bg-yellow-600 text-white rounded hover:bg-yellow-700">
                                        <i class="fa fa-eye mr-1"></i><span x-text="showEmbeddedHtml ? 'Hide inline view' : 'View inline' "></span>
                                    </button>
                                    <button @click="openHtmlFallback" class="px-3 py-1 text-xs font-semibold bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                        <i class="fa fa-up-right-from-square mr-1"></i>Open interactive HTML
                                    </button>
                                    <button @click="retryFetch" class="text-xs text-yellow-700 hover:text-yellow-900 underline">
                                        Retry after regeneration
                                    </button>
                                </div>
                                <div x-show="showEmbeddedHtml" class="mt-3 border border-yellow-200 rounded overflow-hidden" style="min-height: 480px;">
                                    <iframe :src="'/api/artifacts/' + artifact.id + '/image?format=html'" class="w-full" style="min-height: 480px;" sandbox="allow-same-origin allow-scripts allow-popups"></iframe>
                                </div>
                            </div>
                            <div x-show="imageError && !htmlFallback" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-800">
                                <i class="fa fa-exclamation-triangle mr-2"></i>
                                Chart image not available yet. The backend will regenerate it from the stored snapshot.
                                <span x-show="artifact.image_path" class="text-xs block mt-1">Path: <span class="font-mono break-all" x-text="artifact.image_path"></span></span>
                                <button @click="retryFetch" class="mt-2 text-xs text-yellow-700 hover:text-yellow-900 underline">Retry now</button>
                            </div>
                        </div>
                        <div class="mt-2 space-y-1">
                            <p class="text-xs text-gray-500" x-show="artifact.chart_data && artifact.chart_data.minio_url">
                                <i class="fa fa-cloud mr-1"></i> MinIO URL: <span class="font-mono text-xs break-all" x-text="artifact.chart_data.minio_url"></span>
                            </p>
                            <p class="text-xs text-gray-500" x-show="artifact.image_path">
                                <span x-show="artifact.image_path && artifact.image_path.startsWith('http')">Remote Path: </span>
                                <span x-show="artifact.image_path && !artifact.image_path.startsWith('http')">Local Path: </span>
                                <span class="font-mono text-xs break-all" x-text="artifact.image_path"></span>
                            </p>
                            <div class="flex flex-wrap gap-3">
                                <a :href="'/api/artifacts/' + artifact.id + '/image'" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 inline-flex items-center gap-1">
                                    <i class="fa fa-external-link"></i>Open latest image
                                </a>
                                <button x-show="htmlFallback" @click="openHtmlFallback" class="text-xs text-indigo-600 hover:text-indigo-800 inline-flex items-center gap-1">
                                    <i class="fa fa-up-right-from-square"></i>Open HTML fallback
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Data Table Section -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div x-data="{ 
                    marketData: [], 
                    loadingMarketData: false, 
                    marketDataError: null,
                    artifactId: null,
                    loadMarketData() {
                        // Try multiple ways to get artifact ID
                        let id = this.artifactId;
                        let type = null;
                        let symbol = null;
                        
                        // Try from parent Alpine scope
                        if (!id && typeof artifact !== 'undefined' && artifact) {
                            id = artifact.id;
                            type = artifact.type;
                            symbol = artifact.symbol;
                        }
                        
                        // Try from global window object
                        if (!id && window.artifactDetailData && window.artifactDetailData.artifact) {
                            id = window.artifactDetailData.artifact.id;
                            type = window.artifactDetailData.artifact.type;
                            symbol = window.artifactDetailData.artifact.symbol;
                        }
                        
                        if (!id || !symbol || type !== 'chart') {
                            this.marketDataError = 'Artifact is not a chart or has no symbol';
                            this.loadingMarketData = false;
                            return;
                        }
                        
                        this.artifactId = id;
                        this.loadingMarketData = true;
                        this.marketDataError = null;
                        
                        fetch('/api/artifacts/' + id + '/market-data')
                            .then(r => {
                                if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                                return r.json();
                            })
                            .then(d => {
                                this.marketData = Array.isArray(d.data) ? d.data : [];
                                this.loadingMarketData = false;
                                if (this.marketData.length === 0) {
                                    this.marketDataError = 'No market data returned from API';
                                }
                            })
                            .catch(e => {
                                this.marketDataError = e.message || 'Failed to load market data';
                                this.loadingMarketData = false;
                                console.error('Market data error:', e);
                            });
                    }
                }" x-init="
                    // Try to get artifact ID immediately
                    if (typeof artifact !== 'undefined' && artifact && artifact.id) {
                        artifactId = artifact.id;
                        if (artifact.type === 'chart' && artifact.symbol) {
                            setTimeout(() => loadMarketData(), 500);
                        }
                    } else if (window.artifactDetailData && window.artifactDetailData.artifact) {
                        artifactId = window.artifactDetailData.artifact.id;
                        if (window.artifactDetailData.artifact.type === 'chart' && window.artifactDetailData.artifact.symbol) {
                            setTimeout(() => loadMarketData(), 500);
                        }
                    }
                    
                    // Watch for artifact changes
                    $watch('artifact', () => {
                        if (artifact && artifact.id) {
                            artifactId = artifact.id;
                            if (artifact.type === 'chart' && artifact.symbol) {
                                setTimeout(() => loadMarketData(), 100);
                            }
                        }
                    });
                ">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fa fa-table mr-2 text-green-600"></i>Market Data
                        <button @click="loadMarketData()" class="ml-2 text-xs text-blue-600 hover:text-blue-800" x-show="!loadingMarketData">
                            <i class="fa fa-refresh mr-1"></i>Refresh
                        </button>
                    </h3>
                    
                    <div x-show="loadingMarketData" class="text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                        <p class="text-sm text-gray-500 mt-2">Loading market data...</p>
                    </div>
                    
                    <div x-show="marketDataError" class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-sm text-red-800" x-text="'Error: ' + marketDataError"></p>
                        <button @click="loadMarketData()" class="mt-2 text-xs text-red-600 hover:text-red-800 underline">Retry</button>
                    </div>
                    
                    <div x-show="!loadingMarketData && !marketDataError && marketData.length > 0" class="overflow-x-auto">
                        <div class="mb-2 text-xs text-gray-500">
                            Showing <span x-text="marketData.length"></span> bars
                        </div>
                        <p class="text-xs text-gray-500 mb-2">Snapshot data captured with each chart ensures this table loads even if the shared market data cache is empty.</p>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">Date</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Open</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">High</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Low</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Close</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Volume</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="(row, index) in marketData" :key="index">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="row.date ? new Date(row.date).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'}) : 'N/A'"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-gray-900" x-text="row.open != null ? parseFloat(row.open).toFixed(2) : 'N/A'"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-green-600 font-medium" x-text="row.high != null ? parseFloat(row.high).toFixed(2) : 'N/A'"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-red-600 font-medium" x-text="row.low != null ? parseFloat(row.low).toFixed(2) : 'N/A'"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-gray-900 font-semibold" x-text="row.close != null ? parseFloat(row.close).toFixed(2) : 'N/A'"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-gray-500" x-text="row.volume != null ? parseInt(row.volume).toLocaleString() : 'N/A'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <div x-show="!loadingMarketData && !marketDataError && marketData.length === 0" class="text-center py-4 text-gray-500">
                        <i class="fa fa-info-circle mr-2"></i>
                        <p>Market data snapshot is still populating. Please retry in a moment.</p>
                    </div>
                </div>
            </div>

            <!-- Indicators Table Section -->
            <div class="bg-white rounded-lg shadow-sm p-6" x-show="artifact.chart_data && artifact.chart_data.indicators">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fa fa-chart-bar mr-2 text-purple-600"></i>Technical Indicators
                </h3>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Indicator</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="(indicator, index) in (artifact.chart_data?.indicators || [])" :key="index">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900" x-text="indicator"></td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" x-text="indicator.includes('SMA') ? 'Moving Average' : indicator.includes('RSI') ? 'Momentum' : indicator.includes('MACD') ? 'Trend' : indicator.includes('Bollinger') ? 'Volatility' : 'Other'"></td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chart Configuration Section -->
            <div class="bg-white rounded-lg shadow-sm p-6" x-show="artifact.chart_data">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fa fa-cog mr-2 text-gray-600"></i>Chart Configuration
                </h3>
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div x-show="artifact.chart_data.timeframe">
                            <dt class="text-sm font-medium text-gray-500">Timeframe</dt>
                            <dd class="mt-1 text-sm text-gray-900" x-text="artifact.chart_data.timeframe"></dd>
                        </div>
                        <div x-show="artifact.chart_data.bars_count">
                            <dt class="text-sm font-medium text-gray-500">Bars Count</dt>
                            <dd class="mt-1 text-sm text-gray-900" x-text="artifact.chart_data.bars_count"></dd>
                        </div>
                        <div x-show="artifact.chart_data.indicators && artifact.chart_data.indicators.length > 0">
                            <dt class="text-sm font-medium text-gray-500">Indicators Count</dt>
                            <dd class="mt-1 text-sm text-gray-900" x-text="artifact.chart_data.indicators.length"></dd>
                    </div>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Signal Artifact -->
        <div x-show="artifact.type === 'signal'" class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fa fa-signal mr-2 text-purple-600"></i>Trading Signal
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-medium text-gray-500">Action</div>
                    <div class="mt-1 text-lg font-bold" 
                         :class="{
                             'text-green-600': artifact.action === 'BUY',
                             'text-red-600': artifact.action === 'SELL',
                             'text-gray-600': artifact.action === 'HOLD'
                         }"
                         x-text="artifact.action"></div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-medium text-gray-500">Confidence</div>
                    <div class="mt-1 text-lg font-bold text-blue-600" x-text="((artifact.confidence || 0) * 100).toFixed(0) + '%'"></div>
                </div>
                <div x-show="artifact.signal_data?.risk_reward_ratio" class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-medium text-gray-500">Risk/Reward</div>
                    <div class="mt-1 text-lg font-bold text-purple-600" x-text="artifact.signal_data?.risk_reward_ratio || 'N/A'"></div>
                </div>
            </div>

            <div x-show="artifact.signal_data" class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Signal Details</label>
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <pre class="text-xs text-gray-700 overflow-x-auto" x-text="JSON.stringify(artifact.signal_data, null, 2)"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raw Data -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <details>
                <summary class="cursor-pointer text-sm font-medium text-gray-700 hover:text-gray-900">
                    <i class="fa fa-code mr-2"></i>View Raw JSON
                </summary>
                <div class="mt-4 bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <pre class="text-xs text-gray-700 overflow-x-auto" x-text="JSON.stringify(artifact, null, 2)"></pre>
                </div>
            </details>
        </div>
    </div>
</div>

<script>
if (typeof window.showToast !== 'function') {
    window.showToast = function(message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const palette = {
            success: 'bg-green-600',
            error: 'bg-red-600',
            warning: 'bg-yellow-600',
            info: 'bg-blue-600'
        };
        const toast = document.createElement('div');
        toast.className = `${palette[type] || palette.info} text-white px-4 py-2 rounded shadow-lg transition-opacity`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3500);
    };
}

function chartImageViewerState() {
    return {
        artifactSnapshot: null,
        imageLoading: true,
        imageError: false,
        htmlFallback: false,
        htmlPath: null,
        currentSrc: null,
        showEmbeddedHtml: false,
        init() {
            if (typeof artifact !== 'undefined' && artifact) {
                this.syncWithArtifact(artifact);
            }
        },
        syncWithArtifact(latest) {
            if (!latest) {
                return;
            }
            this.artifactSnapshot = latest;
            const originalPath = latest.image_path || '';
            this.htmlFallback = originalPath.toLowerCase().endsWith('.html');
            this.htmlPath = originalPath || null;
            if (this.htmlFallback) {
                this.imageLoading = false;
                this.imageError = true;
                this.currentSrc = null;
            } else {
                this.imageLoading = true;
                this.imageError = false;
                this.currentSrc = `/api/artifacts/${latest.id}/image?t=${Date.now()}`;
            }
        },
        retryFetch() {
            const current = this.artifactSnapshot || (window.artifactDetailData && window.artifactDetailData.artifact);
            if (!current) {
                return;
            }
            this.imageLoading = true;
            this.imageError = false;
            this.currentSrc = `/api/artifacts/${current.id}/image?t=${Date.now()}`;
        },
        onImageLoad() {
            this.imageLoading = false;
            this.imageError = false;
            this.htmlFallback = false;
            if (window.showToast) {
                window.showToast('Chart image regenerated successfully.', 'success');
            }
        },
        onImageError() {
            this.imageLoading = false;
            this.imageError = true;
            if (window.showToast) {
                window.showToast('Chart image still unavailable. Retrying after backend regeneration.', 'error');
            }
        },
        openHtmlFallback() {
            const current = this.artifactSnapshot || (window.artifactDetailData && window.artifactDetailData.artifact);
            if (!current) {
                return;
            }
            if (this.htmlPath && this.htmlPath.startsWith('http')) {
                window.open(this.htmlPath, '_blank');
            } else {
                window.open(`/api/artifacts/${current.id}/image?format=html`, '_blank');
            }
        }
    };
}

function artifactDetailData() {
    return {
        artifact: null,
        loading: true,
        error: null,
        
        async init() {
            // Extract artifact ID from URL
            const pathParts = window.location.pathname.split('/');
            const artifactId = pathParts[pathParts.length - 1];
            
            if (!artifactId || isNaN(artifactId)) {
                this.error = 'Invalid artifact ID';
                this.loading = false;
                return;
            }
            
            await this.loadArtifact(artifactId);
        },
        
        async loadArtifact(id) {
            try {
                this.loading = true;
                this.error = null;
                
                const response = await fetch(`/api/artifacts/${id}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load artifact: HTTP ${response.status}`);
                }
                
                this.artifact = await response.json();
                // Make artifact available globally for nested Alpine.js components
                window.artifactDetailData = { artifact: this.artifact };
            } catch (error) {
                console.error('Error loading artifact:', error);
                this.error = error.message;
            } finally {
                this.loading = false;
            }
        }
    };
}
</script>
{% endblock %}
