FROM apache/airflow:2.10.5

USER root

# Create necessary directories with proper permissions
RUN mkdir -p /app/charts && \
    chmod -R 777 /app/charts && \
    echo "✓ Created /app/charts directory with full permissions"

# Install system dependencies for ML packages (lightgbm, xgboost, etc.)
# Also install .NET 8.0 runtime for stock-indicators library using official install script
# Note: stock-indicators requires .NET runtime to work
# Install Chromium for Kaleido chart generation (Plotly image export)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgomp1 \
    wget \
    ca-certificates \
    chromium \
    chromium-driver \
    && wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh \
    && chmod +x dotnet-install.sh \
    && ./dotnet-install.sh --channel 8.0 --install-dir /usr/share/dotnet \
    && ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet \
    && rm dotnet-install.sh \
    && rm -rf /var/lib/apt/lists/*

# Install uv for ultra-fast package management (10-100x faster than pip)
RUN python3 -m pip install --no-cache-dir uv

# Switch to airflow user to install packages in their environment
USER airflow

# Install additional ML and data processing packages using uv
# uv is much faster and more reliable than pip for large packages
# Install to airflow user's Python environment (same as Airflow itself)
RUN uv pip install --no-cache \
    xgboost \
    mlflow \
    kafka-python \
    catboost \
    pyspark \
    lightgbm \
    imblearn \
    scikit-learn \
    tqdm \
    tqdm-joblib \
    confluent-kafka \
    pandas \
    numpy \
    matplotlib \
    mplfinance \
    plotly \
    kaleido \
    stock-indicators \
    pandas-ta \
    pydantic \
    openai \
    anthropic \
    ib-insync \
    minio \
    && echo "✓ Installed ML and data processing packages using uv"

# Patch the hardcoded timeout from 120 seconds to 300 seconds
# This fixes the "No response from gunicorn master within 120 seconds" error
RUN find /home/airflow/.local/lib -name "command.py" -path "*/airflow/www/*" -exec sed -i 's/\b120\b/300/g' {} \; && \
    echo "✓ Patched Airflow webserver timeout from 120 to 300 seconds"

# Set Chromium path for Kaleido (chart generation)
ENV CHROME_BIN=/usr/bin/chromium
ENV CHROMIUM_PATH=/usr/bin/chromium

USER airflow

# Verify the webserver command works
RUN airflow webserver --help | head -1
