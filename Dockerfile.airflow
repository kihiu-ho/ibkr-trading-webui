FROM apache/airflow:2.10.5

USER root

# Install system dependencies for ML packages (lightgbm, xgboost, etc.)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# Install uv for ultra-fast package management (10-100x faster than pip)
RUN python3 -m pip install --no-cache-dir uv

# Switch to airflow user to install packages in their environment
USER airflow

# Install additional ML and data processing packages using uv
# uv is much faster and more reliable than pip for large packages
# Install to airflow user's Python environment (same as Airflow itself)
RUN uv pip install --no-cache \
    xgboost \
    mlflow \
    kafka-python \
    catboost \
    pyspark \
    lightgbm \
    imblearn \
    scikit-learn \
    tqdm \
    tqdm-joblib \
    confluent-kafka \
    pandas \
    numpy \
    matplotlib \
    mplfinance \
    pydantic \
    openai \
    anthropic \
    ib-insync \
    && echo "✓ Installed ML and data processing packages using uv"

# Patch the hardcoded timeout from 120 seconds to 300 seconds
# This fixes the "No response from gunicorn master within 120 seconds" error
RUN find /home/airflow/.local/lib -name "command.py" -path "*/airflow/www/*" -exec sed -i 's/\b120\b/300/g' {} \; && \
    echo "✓ Patched Airflow webserver timeout from 120 to 300 seconds"

USER airflow

# Verify the webserver command works
RUN airflow webserver --help | head -1
