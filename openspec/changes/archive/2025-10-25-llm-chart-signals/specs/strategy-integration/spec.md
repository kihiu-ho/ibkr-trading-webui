# Strategy Integration for LLM Signals - Spec

## ADDED Requirements

### Requirement: Strategy Model with LLM Configuration
The system SHALL allow strategies to configure LLM-based signal generation.

#### Scenario: Configure LLM for strategy
- **GIVEN** a strategy being created or updated
- **WHEN** setting LLM configuration
- **THEN** the system SHALL store:
  - `llm_enabled`: Boolean flag to enable/disable LLM signals
  - `llm_model`: Model name (gpt-4-vision, gemini-2.0-flash)
  - `llm_language`: Language for prompts (en, zh)
  - `timeframes`: List of timeframes to analyze (1d, 1w, 1mo)
  - `consolidate_timeframes`: Whether to consolidate multi-timeframe analysis
  - `prompt_customization`: Optional custom prompt additions

#### Scenario: Default LLM configuration
- **GIVEN** a new strategy without LLM config
- **WHEN** LLM features are enabled
- **THEN** the system SHALL use defaults:
  - `llm_enabled`: false
  - `llm_model`: "gpt-4-vision"
  - `llm_language`: "en"
  - `timeframes`: ["1d", "1w"]
  - `consolidate_timeframes`: true

### Requirement: Trading Signal Model
The system SHALL create and store trading signals generated by LLM analysis.

#### Scenario: Create trading signal
- **GIVEN** LLM analysis results
- **WHEN** storing a new signal
- **THEN** the system SHALL save:
  - `symbol`: Stock symbol
  - `strategy_id`: Associated strategy
  - `signal_type`: BUY/SELL/HOLD
  - `confidence`: Confidence level (derived from confirmation count)
  - `timeframe_primary`: Primary timeframe (usually daily)
  - `timeframe_confirmation`: Confirmation timeframe (usually weekly)
  - `entry_price_low`: Entry range low
  - `entry_price_high`: Entry range high
  - `stop_loss`: Stop loss price
  - `target_conservative`: Conservative target
  - `target_aggressive`: Aggressive target
  - `r_multiple_conservative`: R-multiple for conservative target
  - `r_multiple_aggressive`: R-multiple for aggressive target
  - `position_size_percent`: Recommended position size
  - `confirmation_signals`: JSON with 3/4 rule details
  - `analysis_text`: Full LLM analysis text
  - `chart_url_daily`: URL to daily chart
  - `chart_url_weekly`: URL to weekly chart
  - `generated_at`: Timestamp
  - `expires_at`: Signal expiration timestamp
  - `status`: active/expired/executed

#### Scenario: Signal expiration
- **GIVEN** a trading signal with generated_at timestamp
- **WHEN** checking signal validity
- **THEN** the system SHALL:
  - Mark signals older than 24 hours as expired for daily signals
  - Mark signals older than 7 days as expired for weekly signals
  - Not return expired signals in active query results

### Requirement: Signal Generation API
The system SHALL provide endpoints to generate and retrieve trading signals.

#### Scenario: Generate signal for single symbol
- **GIVEN** a valid symbol and strategy
- **WHEN** POST to /api/signals/generate
- **THEN** the system SHALL:
  1. Generate charts for configured timeframes
  2. Call LLM to analyze each timeframe
  3. Consolidate analyses if configured
  4. Parse trading signals from LLM responses
  5. Store signal in database
  6. Return complete signal with charts and analysis

#### Scenario: Batch generate signals
- **GIVEN** a strategy with multiple symbols
- **WHEN** POST to /api/signals/batch
- **THEN** the system SHALL:
  - Generate signals for all symbols in strategy
  - Process in parallel (max 5 concurrent)
  - Return summary with success/failure count
  - Store all successful signals

#### Scenario: Get latest signal for symbol
- **GIVEN** a symbol with existing signals
- **WHEN** GET /api/signals/{symbol}
- **THEN** the system SHALL:
  - Return most recent active signal
  - Include chart URLs
  - Include full analysis
  - Return 404 if no active signals

### Requirement: Signal History and Tracking
The system SHALL track signal performance and history.

#### Scenario: Query signal history
- **GIVEN** filters for symbol, date range, strategy
- **WHEN** GET /api/signals/history
- **THEN** the system SHALL return:
  - All signals matching filters
  - Paginated results
  - Include execution status
  - Include actual outcome if executed

#### Scenario: Update signal status
- **GIVEN** a signal that was acted upon
- **WHEN** updating the signal
- **THEN** the system SHALL:
  - Set status to "executed"
  - Record execution_price and execution_time
  - Allow tracking of outcome vs. prediction

## API Contracts

### Generate Signal Request
```python
POST /api/signals/generate
{
    "symbol": str,
    "strategy_id": int,          # Optional, use strategy config
    "timeframes": list[str],     # Optional override
    "force_regenerate": bool     # Ignore existing recent signals
}
```

### Generate Signal Response
```python
{
    "signal_id": int,
    "symbol": str,
    "signal_type": str,          # BUY/SELL/HOLD
    "confidence": float,         # 0.0-1.0
    "entry_price_low": float,
    "entry_price_high": float,
    "stop_loss": float,
    "target_conservative": float,
    "target_aggressive": float,
    "r_multiple_conservative": float,
    "r_multiple_aggressive": float,
    "position_size_percent": float,
    "confirmation": {
        "signals_confirmed": int,  # X out of 4
        "passed": bool,
        "supertrend": str,
        "price_vs_ma20": str,
        "macd": str,
        "rsi": str
    },
    "charts": {
        "daily_url": str,
        "weekly_url": str
    },
    "analysis": {
        "daily": str,
        "weekly": str,
        "consolidated": str
    },
    "generated_at": datetime,
    "expires_at": datetime,
    "model_used": str
}
```

### Batch Generate Request
```python
POST /api/signals/batch
{
    "strategy_id": int,          # Use symbols from strategy
    "symbols": list[str],        # Or explicit symbol list
    "parallel_limit": int        # Default 5
}
```

### Batch Generate Response
```python
{
    "total": int,
    "successful": int,
    "failed": int,
    "signals": list[SignalResponse],
    "errors": list[{
        "symbol": str,
        "error": str
    }]
}
```

## Database Schema

### Strategy Model Extension
```sql
ALTER TABLE strategies ADD COLUMN llm_enabled BOOLEAN DEFAULT FALSE;
ALTER TABLE strategies ADD COLUMN llm_model VARCHAR(50) DEFAULT 'gpt-4-vision';
ALTER TABLE strategies ADD COLUMN llm_language VARCHAR(5) DEFAULT 'en';
ALTER TABLE strategies ADD COLUMN timeframes JSONB DEFAULT '["1d", "1w"]';
ALTER TABLE strategies ADD COLUMN consolidate_timeframes BOOLEAN DEFAULT TRUE;
ALTER TABLE strategies ADD COLUMN prompt_customization TEXT;
```

### Trading Signal Model
```sql
CREATE TABLE trading_signals (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(50) NOT NULL,
    strategy_id INTEGER REFERENCES strategies(id),
    signal_type VARCHAR(10) NOT NULL,  -- BUY/SELL/HOLD
    confidence FLOAT,
    timeframe_primary VARCHAR(10) NOT NULL,
    timeframe_confirmation VARCHAR(10),
    entry_price_low FLOAT,
    entry_price_high FLOAT,
    stop_loss FLOAT,
    target_conservative FLOAT,
    target_aggressive FLOAT,
    r_multiple_conservative FLOAT,
    r_multiple_aggressive FLOAT,
    position_size_percent FLOAT,
    confirmation_signals JSONB,
    analysis_text TEXT,
    chart_url_daily VARCHAR(500),
    chart_url_weekly VARCHAR(500),
    generated_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,
    status VARCHAR(20) DEFAULT 'active',  -- active/expired/executed
    execution_price FLOAT,
    execution_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_symbol_status (symbol, status),
    INDEX idx_strategy_id (strategy_id),
    INDEX idx_generated_at (generated_at DESC)
);
```

## Technical Implementation

### Signal Generator Service
```python
class SignalGenerator:
    def __init__(
        chart_generator: ChartGenerator,
        llm_service: LLMService,
        db: Database
    ):
        ...
    
    async def generate_signal(
        symbol: str,
        strategy: Strategy
    ) -> TradingSignal:
        # 1. Generate charts
        daily_chart = await chart_generator.generate_chart(symbol, "1d")
        weekly_chart = await chart_generator.generate_chart(symbol, "1w")
        
        # 2. LLM analysis
        daily_analysis = await llm_service.analyze_chart(
            daily_chart.url, "daily", symbol, strategy.llm_language
        )
        weekly_analysis = await llm_service.analyze_chart(
            weekly_chart.url, "weekly", symbol, strategy.llm_language
        )
        
        # 3. Consolidate
        if strategy.consolidate_timeframes:
            final = await llm_service.consolidate_analyses(
                daily_analysis, weekly_analysis
            )
        else:
            final = daily_analysis
        
        # 4. Create signal
        signal = TradingSignal(
            symbol=symbol,
            strategy_id=strategy.id,
            signal_type=final.parsed_signal.signal,
            ...
        )
        db.add(signal)
        db.commit()
        
        return signal
```

