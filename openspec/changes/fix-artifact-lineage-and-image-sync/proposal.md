# fix-artifact-lineage-and-image-sync Proposal

## Why
- Chart artifacts rendered in the Artifact Detail page still surface `run_id` and `experiment_id` as `null` (example: artifact 24 captured on November 15, 2025). Without MLflow lineage we cannot trace which run generated a chart, so the "View in MLflow" affordances and workflow auditing flows stall, even though the DAG already produces a valid MLflow run via `mlflow_run_context`.
- The `/api/artifacts/{id}/image` endpoint currently streams whatever path is stored on the row. When the MinIO path is missing, stale, or formatted differently, the response diverges from the canonical technical chart generated by the reference web UI (`reference/webapp/app.py`) that draws indicators off of the stored market data snapshot. In practice, artifact 24 streams a different PNG than the MinIO URL embedded in its metadata even though the metadata carries all OHLCV bars.
- Because the backend never reconciles MLflow lineage or chart rendering, the UI shows `null` values inside the workflow context banner, the "Market Data Refresh" section cannot link back to MLflow experiments, and QA cannot reproduce charts from stored metadata to verify signals.

## What Changes
- Capture and persist MLflow `run_id` and `experiment_id` whenever Airflow tasks call `store_chart_artifact`, `store_llm_artifact`, and `store_signal_artifact`, and retroactively hydrate legacy rows using the latest `mlflow_run_id` returned by `log_workflow_to_mlflow`.
- Extend the artifacts API so reads always include lineage fields (hydrated from MLflow when missing) and provide a repair pathway for previously stored artifacts with null lineage.
- Rework `/api/artifacts/{id}/image` to honor the artifact's `chart_data.minio_url` and `metadata.market_data_snapshot`: first proxy from MinIO using authenticated access, and when the object is unavailable, regenerate the chart using the same indicator + styling pipeline defined in `reference/webapp/app.py` so that the streamed bytes always reflect the stored market data.
- Add tracing/observability (structured logs + metrics) around lineage hydration and chart regeneration to highlight artifacts that still lack MLflow linkage or render fallbacks.

## Impact
- Requires updating Airflow DAG utilities (`dags/utils/artifact_storage.py`, workflow tasks) and backend routes, but no database migrations.
- Slightly longer response time for `/api/artifacts/{id}/image` when regeneration is needed, so we must add caching headers and guardrails.
- Backend gains new dependencies on the chart generation helper already vendored under `reference/webapp`; we can share that module to avoid divergence.
