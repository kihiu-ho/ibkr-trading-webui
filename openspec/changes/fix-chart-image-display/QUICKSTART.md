# Chart Image Display - Quick Reference

## Overview

Chart images generated by Airflow workflows are now accessible through an authenticated backend proxy that handles MinIO authentication transparently.

## Usage

### Frontend - Viewing Chart Images

**Artifacts List Page:**
```
http://localhost:3000/artifacts
```
- Filter by type: "chart"
- Thumbnails display automatically
- Click artifact to view details

**Artifact Detail Page:**
```
http://localhost:3000/artifacts/{id}
```
- Full-resolution chart image
- Loading spinner during fetch
- Retry button if error occurs
- "Open in new tab" link for testing

### Backend API - Accessing Charts

**Endpoint:**
```
GET /api/artifacts/{artifact_id}/image
```

**Example:**
```bash
curl http://localhost:8000/api/artifacts/7/image -o chart.jpg
```

**Response:**
- `200 OK` - Image successfully retrieved
- `404 Not Found` - Artifact doesn't exist
- `400 Bad Request` - Not a chart artifact

**Headers:**
```
Content-Type: image/jpeg (or image/png)
Content-Disposition: inline; filename="chart-{id}.jpeg"
Cache-Control: public, max-age=3600
```

## Architecture

```
Browser → Backend Proxy → MinIO (authenticated)
   ↓
Frontend          ↓                  ↓
<img src>    FastAPI Route    minio_client.get_object()
```

### Flow

1. **Frontend Request**: `<img src="/api/artifacts/7/image" />`
2. **Backend Query**: Fetch artifact metadata from PostgreSQL
3. **URL Parsing**: Extract MinIO bucket and object path
4. **Authentication**: Use MinIO SDK with access key/secret
5. **Retrieval**: Fetch image data from MinIO
6. **Response**: Stream image to browser with cache headers
7. **Fallback**: Try local file paths if MinIO unavailable

## Configuration

### Environment Variables

```bash
# MinIO Configuration (required)
MINIO_ENDPOINT=minio:9000          # Internal MinIO hostname
MINIO_ACCESS_KEY=<your-key>        # MinIO access credentials
MINIO_SECRET_KEY=<your-secret>     # MinIO secret credentials
MINIO_SECURE=false                 # Use HTTPS (false for dev)

# Optional: Public endpoint for external access
MINIO_PUBLIC_ENDPOINT=localhost:9000
```

### Backend Settings

Located in `backend/config/settings.py`:

```python
MINIO_ENDPOINT: str
MINIO_ACCESS_KEY: str
MINIO_SECRET_KEY: str
MINIO_SECURE: bool = False
```

## Troubleshooting

### Chart Not Displaying

**Symptoms:** Yellow error box "Chart image not available"

**Causes & Solutions:**

1. **MinIO Not Running**
   ```bash
   docker ps | grep minio
   docker-compose up -d ibkr-minio
   ```

2. **Backend Not Running**
   ```bash
   docker ps | grep backend
   docker-compose up -d ibkr-backend
   ```

3. **Wrong MinIO Credentials**
   ```bash
   # Check backend logs
   docker logs ibkr-backend --tail 50 | grep -i minio
   
   # Verify credentials
   docker exec ibkr-backend env | grep MINIO
   ```

4. **File Not in MinIO**
   ```bash
   # List MinIO bucket contents
   docker exec ibkr-minio mc ls minio/trading-charts/charts/
   ```

5. **Network Issues**
   ```bash
   # Test MinIO from backend container
   docker exec ibkr-backend curl -I http://minio:9000
   ```

### Backend Logs

**Check for errors:**
```bash
docker logs ibkr-backend --tail 50
```

**Look for:**
- `INFO:backend.api.chart_images:Fetching chart from MinIO...` ✅
- `ERROR:...Failed to fetch chart from MinIO: 403` ❌
- `ModuleNotFoundError: No module named 'minio'` ❌

### Testing Endpoint Directly

**Test with curl:**
```bash
# Download image
curl -o test.jpg http://localhost:8000/api/artifacts/7/image

# Check file type
file test.jpg

# View headers
curl -I http://localhost:8000/api/artifacts/7/image
```

**Expected Output:**
```
HTTP/1.1 200 OK
content-type: image/jpeg
cache-control: public, max-age=3600
content-length: 319645
```

### Frontend Console Errors

**Open browser DevTools (F12) and check:**

1. **Network Tab**:
   - Request to `/api/artifacts/7/image`
   - Status should be `200 OK`
   - Type should be `image/jpeg`

2. **Console Tab**:
   - Look for `Image load error for artifact X`
   - Check for CORS errors (should not happen with proxy)

## Performance

### Cache Strategy

- **Browser Cache**: 1 hour (3600 seconds)
- **Cache-Control**: Public (CDN-friendly)
- **Reduced Load**: Subsequent requests served from cache

### Response Times

- **First Load**: 50-200ms (MinIO fetch)
- **Cached Load**: < 10ms (browser cache)
- **Backend Processing**: < 5ms (URL parsing + query)

### File Sizes

- **Daily Charts**: ~300-350 KB (1920x1080 JPEG)
- **Weekly Charts**: ~250-300 KB (1920x1080 JPEG)
- **Compression**: JPEG quality 90%

## Security

### Authentication

- ✅ MinIO credentials stored in backend only
- ✅ No credentials exposed to browser
- ✅ Backend validates artifact ownership
- ✅ Authenticated MinIO SDK requests

### Authorization

- ✅ Artifact ID validation
- ✅ Type checking (must be "chart")
- ✅ Database query before serving
- ✅ Generic error messages (no info disclosure)

## API Examples

### Python

```python
import requests

# Get chart image
response = requests.get('http://localhost:8000/api/artifacts/7/image')

if response.status_code == 200:
    with open('chart.jpg', 'wb') as f:
        f.write(response.content)
    print(f"Image saved: {len(response.content)} bytes")
else:
    print(f"Error: {response.status_code}")
```

### JavaScript

```javascript
// Fetch chart image
fetch('/api/artifacts/7/image')
  .then(response => response.blob())
  .then(blob => {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(blob);
    document.body.appendChild(img);
  })
  .catch(error => console.error('Error:', error));
```

### cURL

```bash
# Download chart
curl -o chart.jpg http://localhost:8000/api/artifacts/7/image

# With authentication (if needed)
curl -H "Authorization: Bearer TOKEN" \
     -o chart.jpg \
     http://localhost:8000/api/artifacts/7/image

# Check headers only
curl -I http://localhost:8000/api/artifacts/7/image
```

## Workflow Integration

### Creating Chart Artifacts

**In Airflow DAG:**

```python
from dags.utils.artifact_storage import store_chart_artifact
from dags.utils.minio_storage import upload_chart_to_minio

# Generate chart
chart_result = chart_gen.generate_chart(market_data, config)

# Upload to MinIO
minio_url = upload_chart_to_minio(
    file_path=chart_result.file_path,
    symbol='TSLA',
    timeframe='daily',
    execution_id=str(context['execution_date'])
)

# Store artifact in database
store_chart_artifact(
    name='TSLA Daily Chart',
    symbol='TSLA',
    image_path=minio_url,  # Use MinIO URL
    chart_type='daily',
    workflow_id='ibkr_trading_signal_workflow',
    execution_id=str(context['execution_date']),
    chart_data={
        'indicators': chart_result.indicators_included,
        'minio_url': minio_url,
        'local_path': chart_result.file_path
    }
)
```

### Artifact Data Structure

```json
{
  "id": 7,
  "type": "chart",
  "name": "TSLA Daily Chart",
  "symbol": "TSLA",
  "image_path": "http://localhost:9000/trading-charts/charts/TSLA/daily/20251115_051322_1ebbc0f4.jpeg",
  "chart_type": "daily",
  "chart_data": {
    "indicators": ["SMA_20", "SMA_50", "SMA_200", "Bollinger_Bands", "SuperTrend", "MACD", "RSI", "OBV", "ATR", "Volume"],
    "timeframe": "daily",
    "bars_count": 200,
    "minio_url": "http://localhost:9000/trading-charts/charts/TSLA/daily/20251115_051322_1ebbc0f4.jpeg",
    "local_path": "/app/charts/TSLA_1D_20251115_051313.jpeg"
  }
}
```

## Best Practices

### 1. Always Use Proxy Endpoint

❌ **Don't:**
```html
<img src="http://localhost:9000/trading-charts/charts/TSLA/daily/chart.jpeg">
```

✅ **Do:**
```html
<img src="/api/artifacts/7/image">
```

### 2. Handle Errors Gracefully

```javascript
const img = document.createElement('img');
img.src = '/api/artifacts/7/image';
img.onerror = () => {
  console.error('Failed to load chart');
  img.alt = 'Chart not available';
};
```

### 3. Use Cache Busting for Updates

```javascript
// Force reload
const timestamp = Date.now();
img.src = `/api/artifacts/7/image?t=${timestamp}`;
```

### 4. Store Both MinIO and Local Paths

```python
# Redundancy for reliability
chart_data = {
    'minio_url': minio_url,      # Primary
    'local_path': local_path      # Fallback
}
```

## Monitoring

### Health Checks

```bash
# Backend health
curl http://localhost:8000/health

# MinIO health
curl http://localhost:9000/minio/health/live

# Test chart endpoint
curl -I http://localhost:8000/api/artifacts/7/image
```

### Metrics to Track

- Response time (p50, p95, p99)
- Cache hit rate
- Error rate (4xx, 5xx)
- MinIO latency
- Bandwidth usage

## Related Documentation

- **Proposal**: `openspec/changes/fix-chart-image-display/proposal.md`
- **Test Results**: `openspec/changes/fix-chart-image-display/test-results.md`
- **Implementation Tasks**: `openspec/changes/fix-chart-image-display/tasks.md`
- **Backend Code**: `backend/api/chart_images.py`
- **Frontend Template**: `frontend/templates/artifact_detail.html`

## Support

### Getting Help

1. **Check logs**: `docker logs ibkr-backend --tail 50`
2. **Test endpoint**: `curl -I http://localhost:8000/api/artifacts/7/image`
3. **Verify MinIO**: `docker ps | grep minio`
4. **Check credentials**: `docker exec ibkr-backend env | grep MINIO`

### Common Issues

| Issue | Solution |
|-------|----------|
| 404 Not Found | Artifact doesn't exist in database |
| 403 Forbidden | MinIO credentials incorrect |
| 503 Service Unavailable | MinIO not running |
| Timeout | Network issue or MinIO slow |
| Invalid image | Corrupted file in MinIO |

## Quick Start

1. **Verify services running**:
   ```bash
   docker ps | grep -E 'backend|minio'
   ```

2. **Test endpoint**:
   ```bash
   curl -o test.jpg http://localhost:8000/api/artifacts/7/image
   file test.jpg
   ```

3. **Open in browser**:
   ```
   http://localhost:3000/artifacts/7
   ```

4. **Check image displays** ✅

---

**Last Updated**: November 15, 2025  
**Status**: ✅ Production Ready
