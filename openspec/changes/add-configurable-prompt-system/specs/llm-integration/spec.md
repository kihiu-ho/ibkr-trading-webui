# LLM Integration Spec Deltas

## ADDED Requirements

### Requirement: Configurable Prompt Templates
The system SHALL load prompt templates from the database with strategy-specific support.

#### Scenario: Load prompt from database
- **GIVEN** a request to analyze a chart with prompt_type="daily_chart" and language="en"
- **WHEN** the LLM service prepares the prompt
- **THEN** the system SHALL:
  - Query prompt_templates table for (prompt_type, language, is_default=TRUE)
  - Cache the prompt in memory for 5 minutes
  - Substitute variables ({{symbol}}, {{now}}, etc.) into the template
  - Return the prepared prompt text

#### Scenario: Fallback to hardcoded prompt
- **GIVEN** database query fails or returns no prompt
- **WHEN** preparing prompt
- **THEN** the system SHALL:
  - Log warning "Prompt not found in database, using fallback"
  - Use hardcoded prompt from PROMPT_TEMPLATES dict
  - Continue normally without crashing

#### Scenario: Cache invalidation
- **GIVEN** a prompt template is updated in the database
- **WHEN** the update API is called
- **THEN** the system SHALL:
  - Clear the cached prompt for that (prompt_type, language)
  - Next analysis will load fresh prompt from database

#### Scenario: Use specific prompt version
- **GIVEN** a request specifies prompt_template_id parameter
- **WHEN** analyzing a chart
- **THEN** the system SHALL:
  - Load that specific prompt by ID (bypassing default lookup)
  - Use it for analysis
  - Store the prompt_template_id in results

### Requirement: Prompt Template Variables
The system SHALL support variable substitution in prompt templates.

#### Scenario: Substitute basic variables
- **GIVEN** a prompt template contains "Symbol: {{symbol}}, Date: {{now}}"
- **WHEN** rendering the prompt for symbol="AAPL"
- **THEN** the system SHALL substitute:
  - {{symbol}} → "AAPL"
  - {{now}} → current timestamp formatted as ISO date
  - {{timeframe}} → "daily" or "weekly"

#### Scenario: Substitute analysis text
- **GIVEN** consolidation prompt contains "## Daily Analysis\n{{daily_analysis}}\n\n## Weekly Analysis\n{{weekly_analysis}}"
- **WHEN** rendering with daily and weekly analysis text
- **THEN** the system SHALL:
  - Replace {{daily_analysis}} with the daily chart analysis text
  - Replace {{weekly_analysis}} with the weekly chart analysis text
  - Preserve formatting and newlines

#### Scenario: Handle missing variables
- **GIVEN** a prompt template contains undefined variable {{foo}}
- **WHEN** rendering the prompt
- **THEN** the system SHALL:
  - Log warning "Undefined variable: foo"
  - Replace {{foo}} with empty string or "[MISSING: foo]"
  - Continue rendering other variables

### Requirement: Prompt Traceability
The system SHALL link every generated signal to the prompt template used.

#### Scenario: Store prompt reference in signal
- **GIVEN** a signal is generated using a prompt template
- **WHEN** saving the signal to database
- **THEN** the system SHALL:
  - Store prompt_template_id in trading_signals table
  - Include prompt version number in metadata
  - Record timestamp when prompt was loaded

#### Scenario: Display prompt in signal detail
- **GIVEN** a user views a signal detail page
- **WHEN** the signal was generated with a database prompt
- **THEN** the system SHALL display:
  - Prompt template name and version
  - Link to view the full prompt
  - Timestamp of when signal was generated
  - Language used (en/zh)

#### Scenario: Audit trail query
- **GIVEN** an administrator needs to find all signals generated by a prompt
- **WHEN** querying signals by prompt_template_id
- **THEN** the system SHALL:
  - Return all signals linked to that prompt
  - Include signal outcomes (profit/loss if closed)
  - Calculate aggregate metrics (win rate, avg R-multiple)

### Requirement: Multilingual Prompt Support
The system SHALL support both English and Chinese prompt templates.

#### Scenario: Load Chinese prompt
- **GIVEN** language parameter is set to "zh"
- **WHEN** loading a daily_chart prompt
- **THEN** the system SHALL:
  - Query for prompt_type="daily_chart" AND language="zh"
  - Return Chinese template from reference workflow
  - Apply Chinese terminology translations
  - Generate Chinese analysis text

#### Scenario: Language fallback
- **GIVEN** a prompt is requested for language="zh" but not found
- **WHEN** loading the prompt
- **THEN** the system SHALL:
  - Log warning "Chinese prompt not found, falling back to English"
  - Load English prompt for same type
  - Continue with English analysis

#### Scenario: Mixed language consolidation
- **GIVEN** daily analysis in Chinese and weekly in English
- **WHEN** consolidating analyses
- **THEN** the system SHALL:
  - Use consolidation prompt in the language of daily analysis (primary)
  - Preserve both analysis texts as-is
  - Generate final report in primary language

### Requirement: Strategy-Specific Prompt Support
The system SHALL support strategy-specific prompts with fallback to global defaults.

#### Scenario: Load strategy-specific prompt
- **GIVEN** a request to analyze with strategy_id="abc-123", prompt_type="daily_chart", language="en"
- **WHEN** loading the prompt
- **THEN** the system SHALL:
  - Query for prompt WHERE strategy_id="abc-123" AND prompt_type="daily_chart" AND language="en" AND is_default=TRUE
  - If found, use strategy-specific prompt
  - If not found, query for prompt WHERE strategy_id IS NULL (global default)
  - Cache with key including strategy_id

#### Scenario: Create strategy-specific prompt override
- **GIVEN** a global default prompt exists for daily_chart + en
- **WHEN** creating a prompt with strategy_id="abc-123"
- **THEN** the system SHALL:
  - Create prompt with strategy_id FK
  - Allow setting as default for that strategy
  - Not affect global default or other strategies

### Requirement: Full Jinja2 Template Rendering
The system SHALL support full Jinja2 template engine with filters, functions, and control flow.

#### Scenario: Render template with filters
- **GIVEN** a prompt contains "{{now | date('%Y-%m-%d')}}" and "{{symbol | upper}}"
- **WHEN** rendering with now=datetime(2024,1,15,10,30) and symbol="aapl"
- **THEN** the system SHALL output "2024-01-15" and "AAPL"

#### Scenario: Render template with conditionals
- **GIVEN** a prompt contains "{% if trend == 'bullish' %}Buy signal{% else %}Sell signal{% endif %}"
- **WHEN** rendering with trend="bullish"
- **THEN** the system SHALL output "Buy signal"

#### Scenario: Render template with loops
- **GIVEN** a prompt contains "{% for sig in previous_analyses[:3] %}{{sig.date}}: {{sig.outcome}}{% endfor %}"
- **WHEN** rendering with list of 5 previous analyses
- **THEN** the system SHALL:
  - Iterate over first 3 items only
  - Output each date and outcome
  - Join without extra whitespace

#### Scenario: Handle Jinja2 template errors
- **GIVEN** a prompt has invalid syntax "{{symbol | nonexistent_filter}}"
- **WHEN** rendering
- **THEN** the system SHALL:
  - Raise clear error message: "Unknown filter 'nonexistent_filter'"
  - Log the prompt template_id and error
  - Not crash the application

### Requirement: Prompt Performance Tracking
The system SHALL track and aggregate performance metrics for each prompt template.

#### Scenario: Record signal outcome for performance
- **GIVEN** a signal generated with prompt_template_id was closed
- **WHEN** calculating outcome (win/loss, R-multiple, profit_loss)
- **THEN** the system SHALL store in trading_signals table for aggregation

#### Scenario: Daily performance aggregation
- **GIVEN** a Celery Beat task runs daily at midnight
- **WHEN** calculating performance for each prompt
- **THEN** the system SHALL:
  - Query all signals for date = yesterday
  - Group by prompt_template_id and strategy_id
  - Aggregate: signals_generated, signals_executed, win_count, loss_count, total_profit_loss, avg_r_multiple, best_r_multiple, worst_r_multiple, avg_profit_pct
  - Insert/update prompt_performance table
  - Complete within 5 minutes for 10,000 signals

#### Scenario: Retrieve performance metrics
- **GIVEN** a request for prompt performance
- **WHEN** calling GET /api/v1/prompts/{id}/performance?from=2024-01-01&to=2024-01-31
- **THEN** the system SHALL return:
  - Daily aggregated metrics for date range
  - Cumulative totals
  - Trend indicators (improving/declining)
  - Comparison to global average

#### Scenario: Compare prompt performance
- **GIVEN** multiple prompts exist for same type+language+strategy
- **WHEN** calling GET /api/v1/prompts/compare?ids=id1,id2,id3
- **THEN** the system SHALL return:
  - Side-by-side metrics for each prompt
  - Statistical comparison (which is better and by how much)
  - Time-series data for trend visualization

## MODIFIED Requirements

### Requirement: Prompt Template System
The system SHALL use structured prompts **loaded from the database** with **full Jinja2 template rendering** based on the reference workflow.

#### Scenario: Daily chart analysis prompt
- **GIVEN** a request to analyze a daily chart
- **WHEN** constructing the prompt
- **THEN** the system SHALL:
  - **Load from database** using prompt_type="daily_chart" and language setting
  - Include analysis date and symbol via variable substitution
  - Include all sections from template: Core price analysis, Trend indicators, Confirmation indicators, 3/4 signal system, Trading recommendation, Risk assessment
  - Support both English and Chinese templates

#### Scenario: Weekly chart analysis prompt  
- **GIVEN** a request to analyze a weekly chart
- **WHEN** constructing the prompt
- **THEN** the system SHALL:
  - **Load from database** using prompt_type="weekly_chart" and language setting
  - Include all sections from template: Medium-term trend, Key price levels, Weekly indicators, Price patterns, Volume characteristics, Daily-weekly correlation, 30-180 day outlook

#### Scenario: Consolidation prompt
- **GIVEN** daily and weekly analyses
- **WHEN** requesting final recommendation
- **THEN** the system SHALL:
  - **Load from database** using prompt_type="consolidation" and language setting
  - Substitute {{daily_analysis}} and {{weekly_analysis}} variables
  - Include all sections from template: Multi-timeframe signal confirmation, Detailed trading recommendations, Risk assessment, Conclusion

