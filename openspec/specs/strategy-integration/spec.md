# strategy-integration Specification

## Purpose
TBD - created by archiving change llm-chart-signals. Update Purpose after archive.
## Requirements
### Requirement: Strategy Model with LLM Configuration
The system SHALL allow strategies to configure LLM-based signal generation.

#### Scenario: Configure LLM for strategy
- **GIVEN** a strategy being created or updated
- **WHEN** setting LLM configuration
- **THEN** the system SHALL store:
  - `llm_enabled`: Boolean flag to enable/disable LLM signals
  - `llm_model`: Model name (gpt-4-vision, gemini-2.0-flash)
  - `llm_language`: Language for prompts (en, zh)
  - `timeframes`: List of timeframes to analyze (1d, 1w, 1mo)
  - `consolidate_timeframes`: Whether to consolidate multi-timeframe analysis
  - `prompt_customization`: Optional custom prompt additions

#### Scenario: Default LLM configuration
- **GIVEN** a new strategy without LLM config
- **WHEN** LLM features are enabled
- **THEN** the system SHALL use defaults:
  - `llm_enabled`: false
  - `llm_model`: "gpt-4-vision"
  - `llm_language`: "en"
  - `timeframes`: ["1d", "1w"]
  - `consolidate_timeframes`: true

### Requirement: Trading Signal Model
The system SHALL create and store trading signals generated by LLM analysis.

#### Scenario: Create trading signal
- **GIVEN** LLM analysis results
- **WHEN** storing a new signal
- **THEN** the system SHALL save:
  - `symbol`: Stock symbol
  - `strategy_id`: Associated strategy
  - `signal_type`: BUY/SELL/HOLD
  - `confidence`: Confidence level (derived from confirmation count)
  - `timeframe_primary`: Primary timeframe (usually daily)
  - `timeframe_confirmation`: Confirmation timeframe (usually weekly)
  - `entry_price_low`: Entry range low
  - `entry_price_high`: Entry range high
  - `stop_loss`: Stop loss price
  - `target_conservative`: Conservative target
  - `target_aggressive`: Aggressive target
  - `r_multiple_conservative`: R-multiple for conservative target
  - `r_multiple_aggressive`: R-multiple for aggressive target
  - `position_size_percent`: Recommended position size
  - `confirmation_signals`: JSON with 3/4 rule details
  - `analysis_text`: Full LLM analysis text
  - `chart_url_daily`: URL to daily chart
  - `chart_url_weekly`: URL to weekly chart
  - `generated_at`: Timestamp
  - `expires_at`: Signal expiration timestamp
  - `status`: active/expired/executed

#### Scenario: Signal expiration
- **GIVEN** a trading signal with generated_at timestamp
- **WHEN** checking signal validity
- **THEN** the system SHALL:
  - Mark signals older than 24 hours as expired for daily signals
  - Mark signals older than 7 days as expired for weekly signals
  - Not return expired signals in active query results

### Requirement: Signal Generation API
The system SHALL provide endpoints to generate and retrieve trading signals.

#### Scenario: Generate signal for single symbol
- **GIVEN** a valid symbol and strategy
- **WHEN** POST to /api/signals/generate
- **THEN** the system SHALL:
  1. Generate charts for configured timeframes
  2. Call LLM to analyze each timeframe
  3. Consolidate analyses if configured
  4. Parse trading signals from LLM responses
  5. Store signal in database
  6. Return complete signal with charts and analysis

#### Scenario: Batch generate signals
- **GIVEN** a strategy with multiple symbols
- **WHEN** POST to /api/signals/batch
- **THEN** the system SHALL:
  - Generate signals for all symbols in strategy
  - Process in parallel (max 5 concurrent)
  - Return summary with success/failure count
  - Store all successful signals

#### Scenario: Get latest signal for symbol
- **GIVEN** a symbol with existing signals
- **WHEN** GET /api/signals/{symbol}
- **THEN** the system SHALL:
  - Return most recent active signal
  - Include chart URLs
  - Include full analysis
  - Return 404 if no active signals

### Requirement: Signal History and Tracking
The system SHALL track signal performance and history.

#### Scenario: Query signal history
- **GIVEN** filters for symbol, date range, strategy
- **WHEN** GET /api/signals/history
- **THEN** the system SHALL return:
  - All signals matching filters
  - Paginated results
  - Include execution status
  - Include actual outcome if executed

#### Scenario: Update signal status
- **GIVEN** a signal that was acted upon
- **WHEN** updating the signal
- **THEN** the system SHALL:
  - Set status to "executed"
  - Record execution_price and execution_time
  - Allow tracking of outcome vs. prediction

